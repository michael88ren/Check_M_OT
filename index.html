<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Overtime Tracking System - Singapore Edition</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #2ec4b6;
      --light: #f8f9fa;
      --dark: #212529;
      --holiday: #ff6b6b;
      --weekend: #f8f9fa;
      --today: #ffd166;
      --gray: #adb5bd;
      --overtime: #4caf50;
      --late: #ff9800;
      --deduction: #e91e63;
      --saturday: #e3f2fd;
      --sunday: #ffecb3;
      --allowance: #7e57c2;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e0f7fa 0%, #f5f5f5 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 25px 30px;
      text-align: center;
      position: relative;
    }
    
    h1 {
      font-size: 2.4rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      max-width: 600px;
      margin: 0 auto;
    }
    
    #controls {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      padding: 20px;
      background: white;
      border-bottom: 1px solid #eee;
      gap: 15px;
      background: #f8fafc;
    }
    
    .control-group {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
    }
    
    button, select, input[type=month], input[type=number] {
      margin: 0;
      padding: 12px 20px;
      font-size: 15px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    input[type=month], input[type=number] {
      background: white;
      border: 1px solid #ddd;
      padding: 11px 18px;
      min-width: 180px;
    }
    
    input[type=number] {
      width: 120px;
    }
    
    button:active {
      transform: translateY(2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    #exportBtn {
      background: var(--info);
      color: white;
    }
    
    #clockInBtn {
      background: var(--primary);
      color: white;
    }
    
    #clockOutBtn {
      background: var(--secondary);
      color: white;
    }
    
    #holidayToggle {
      background: var(--warning);
      color: white;
    }
    
    #settingsBtn {
      background: #6c757d;
      color: white;
    }
    
    #salaryToggle {
      background: #9c27b0;
      color: white;
    }
    
    #allowanceBtn {
      background: var(--allowance);
      color: white;
    }
    
    .calendar-container {
      padding: 0 20px 20px;
    }
    
    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: var(--primary);
      color: white;
      text-align: center;
      font-weight: 600;
      padding: 15px 0;
      border-radius: 12px 12px 0 0;
      margin-top: 20px;
    }
    
    .weekdays div {
      padding: 8px;
    }
    
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #e0e6ed;
      border-radius: 0 0 12px 12px;
      overflow: hidden;
    }
    
    .day {
      background: white;
      min-height: 150px;
      padding: 15px 12px;
      font-size: 14px;
      position: relative;
      display: flex;
      flex-direction: column;
      transition: all 0.2s ease;
    }
    
    .day:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      z-index: 2;
    }
    
    .day.inactive {
      background: #f8fafc;
      color: #cbd5e1;
    }
    
    .day.saturday {
      background: var(--saturday);
    }
    
    .day.sunday {
      background: var(--sunday);
    }
    
    .day.holiday {
      background: #fff9f9;
      border-left: 4px solid var(--holiday);
    }
    
    .day.holiday .date-label {
      color: var(--holiday);
    }
    
    .day .date-label {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .day .current-indicator {
      background-color: var(--primary);
      color: white;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    .day .overtime-rate {
      background: #ff9800;
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .day .holiday-label {
      background: var(--holiday);
      color: white;
      border-radius: 20px;
      padding: 4px 10px;
      font-size: 12px;
      margin-top: 5px;
      display: inline-block;
      font-weight: 500;
    }
    
    .day .record {
      font-size: 13px;
      padding: 8px 10px;
      background: #f1f8ff;
      border-radius: 8px;
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
    }
    
    .day .record .time {
      font-weight: 600;
      color: var(--primary);
    }
    
    .day.holiday .record {
      background: #fff0f0;
    }
    
    .day .overtime {
      background: #e8f5e9;
      color: var(--overtime);
      font-weight: 600;
      margin-top: 10px;
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      font-size: 13px;
    }
    
    .day .late {
      background: #fff3e0;
      color: var(--late);
      font-weight: 600;
      margin-top: 8px;
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      font-size: 12px;
    }
    
    .day .deduction {
      background: #fce4ec;
      color: var(--deduction);
      font-weight: 600;
      margin-top: 8px;
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      font-size: 12px;
    }
    
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ddd;
      padding: 30px;
      z-index: 1000;
      display: none;
      width: 420px;
      max-width: 90%;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25);
    }
    
    .modal h3 {
      margin-bottom: 25px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.5rem;
    }
    
    .modal label {
      display: block;
      margin: 20px 0 10px;
      font-weight: 600;
      color: #555;
      font-size: 16px;
    }
    
    .modal input[type="time"], .modal input[type="number"] {
      display: block;
      width: 100%;
      padding: 14px 18px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 12px;
      background: #f8f9fa;
      font-weight: 500;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      display: none;
    }
    
    .clock-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }
    
    .clock-buttons button {
      flex: 1;
      padding: 14px;
      font-size: 16px;
    }
    
    #saveBtn {
      background: var(--primary);
      color: white;
    }
    
    #deleteBtn {
      background: var(--danger);
      color: white;
    }
    
    #cancelBtn {
      background: #6c757d;
      color: white;
    }
    
    #notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--primary);
      color: white;
      padding: 18px 28px;
      border-radius: 14px;
      display: none;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      max-width: 380px;
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 16px;
      font-weight: 500;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      padding: 20px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
    }
    
    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card .value {
      font-size: 2.2rem;
      font-weight: 700;
      margin: 10px 0;
    }
    
    .stat-card .label {
      font-size: 1rem;
      color: #6c757d;
      font-weight: 500;
    }
    
    .stat-card.late-deduction {
      background: #fce4ec;
    }
    
    .stat-card.late-deduction .value {
      color: #e91e63;
    }
    
    .stat-card.salary {
      background: #e8f5e9;
    }
    
    .stat-card.salary .value {
      color: #4caf50;
    }
    
    .stat-card.allowance {
      background: #f3e5f5;
    }
    
    .stat-card.allowance .value {
      color: var(--allowance);
    }
    
    footer {
      text-align: center;
      padding: 25px;
      color: #6c757d;
      font-size: 1rem;
      background: #f8f9fa;
      border-top: 1px solid #eee;
    }
    
    .holiday-info {
      background: #fff9f9;
      border: 1px solid #ffebee;
      border-radius: 12px;
      padding: 15px 20px;
      margin: 0 20px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .holiday-info i {
      color: var(--holiday);
      font-size: 24px;
    }
    
    .holiday-info p {
      font-size: 15px;
      color: #d32f2f;
    }
    
    .salary-settings {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      background: #e3f2fd;
      padding: 15px 20px;
      border-radius: 12px;
      margin: 0 20px 20px;
      align-items: center;
    }
    
    .salary-settings label {
      display: flex;
      flex-direction: column;
      font-weight: 500;
      font-size: 14px;
      color: #1565c0;
    }
    
    .salary-settings input {
      margin-top: 5px;
    }
    
    .export-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
      background: #e8f5e9;
      padding: 20px;
      border-radius: 16px;
      margin: 0 20px 20px;
      border: 1px solid #c8e6c9;
    }
    
    .export-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .export-header h3 {
      color: var(--primary);
      font-size: 1.3rem;
    }
    
    .close-export {
      background: transparent;
      border: none;
      color: #666;
      font-size: 1.2rem;
      cursor: pointer;
    }
    
    .export-types {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
    }
    
    .export-types button {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px 10px;
      text-align: center;
      background: var(--info);
      color: white;
    }
    
    .export-types button span {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 5px;
      font-weight: normal;
    }
    
    .export-range {
      display: flex;
      gap: 20px;
      padding-top: 10px;
      border-top: 1px solid #c8e6c9;
      justify-content: center;
    }
    
    .export-range label {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .pay-period-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 18px;
      background: #e3f2fd;
      border-radius: 16px;
      margin: 0 20px 20px;
      border: 1px solid #bbdefb;
    }
    
    .pay-period-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .pay-period-label {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .pay-period-label i {
      color: #ff9800;
      font-size: 18px;
    }
    
    .pay-period {
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      padding: 8px 15px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .pay-period select {
      background: white;
      border: 1px solid #ddd;
      padding: 8px 15px;
      border-radius: 8px;
    }
    
    .period-dates {
      font-weight: 600;
      color: #1565c0;
      padding: 5px 12px;
      background: white;
      border-radius: 8px;
      min-width: 220px;
      display: inline-block;
      text-align: center;
    }
    
    .period-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    
    .period-btn {
      padding: 8px 16px;
      border-radius: 8px;
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    
    .period-explanation {
      font-size: 14px;
      color: #0d47a1;
      padding: 10px;
      background: #bbdefb;
      border-radius: 8px;
      margin-top: 5px;
    }
    
    .allowance-list {
      max-height: 250px;
      overflow-y: auto;
      margin: 15px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px solid #eee;
    }
    
    .allowance-item {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      border-bottom: 1px solid #eee;
      align-items: center;
    }
    
    .allowance-item:last-child {
      border-bottom: none;
    }
    
    .allowance-month {
      font-weight: 600;
    }
    
    .allowance-amount {
      font-weight: 600;
      color: var(--allowance);
    }
    
    @media (max-width: 768px) {
      #controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .control-group {
        flex-direction: column;
      }
      
      .control-group button {
        width: 100%;
      }
      
      .day {
        min-height: 120px;
      }
      
      .stats {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
      
      .salary-settings {
        flex-direction: column;
        align-items: stretch;
      }
      
      .pay-period-row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .export-types {
        grid-template-columns: 1fr;
      }
      
      .export-range {
        flex-direction: column;
        gap: 10px;
      }
    }
    
    @media (max-width: 480px) {
      h1 {
        font-size: 1.8rem;
      }
      
      .weekdays div {
        padding: 5px 0;
        font-size: 13px;
      }
      
      .day {
        min-height: 110px;
        padding: 10px 8px;
      }
      
      .day .date-label {
        font-size: 14px;
      }
      
      .stat-card {
        padding: 15px;
      }
      
      .stat-card .value {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-calendar-alt"></i> Overtime Tracking System - Singapore Edition</h1>
      <p class="subtitle">Track attendance, overtime hours & salary calculation (1.5x/2.0x for weekend overtime)</p>
    </header>
    
    <div id="controls">
      <div class="control-group">
        <input type="month" id="monthPicker">
        <button id="clockInBtn">
          <i class="fas fa-sign-in-alt"></i> Clock In
        </button>
        <button id="clockOutBtn">
          <i class="fas fa-sign-out-alt"></i> Clock Out
        </button>
        <button id="holidayToggle" onclick="toggleHolidays()">
          <i class="fas fa-calendar-day"></i> Holiday View
        </button>
        <button id="salaryToggle" onclick="toggleSalary()">
          <i class="fas fa-eye-slash"></i> Hide Salary
        </button>
      </div>
      
      <div class="control-group">
        <button id="exportBtn" onclick="showExportOptions()">
          <i class="fas fa-file-export"></i> Export Data
        </button>
        <button id="settingsBtn" onclick="openSettings()">
          <i class="fas fa-cog"></i> Settings
        </button>
        <button id="allowanceBtn" onclick="openAllowanceModal()">
          <i class="fas fa-money-bill-wave"></i> Manage Allowance
        </button>
      </div>
    </div>
    
    <div class="pay-period-container">
      <div class="pay-period-row">
        <div class="pay-period-label">
          <i class="fas fa-calendar-check"></i>
          <span>Pay Period:</span>
        </div>
        <div class="pay-period">
          <select id="payPeriodSelect" onchange="updatePayPeriod()">
            <option value="current">Current Month</option>
            <option value="last">Last Month</option>
            <option value="custom">Custom Period</option>
          </select>
          <span id="payPeriodDates" class="period-dates">2025-05-18 to 2025-06-17</span>
        </div>
      </div>
      
      <div class="period-controls">
        <button class="period-btn" onclick="adjustPeriod(-1)">
          <i class="fas fa-chevron-left"></i> Prev
        </button>
        <button class="period-btn" onclick="adjustPeriod(1)">
          Next <i class="fas fa-chevron-right"></i>
        </button>
        <button class="period-btn" onclick="applyCustomPeriod()">
          <i class="fas fa-check"></i> Apply
        </button>
      </div>
      
      <div class="period-explanation">
        <i class="fas fa-info-circle"></i>
        Pay period: 18th of previous month to 17th of current month
      </div>
    </div>
    
    <div class="export-options" id="exportOptions" style="display: none;">
      <div class="export-header">
        <h3><i class="fas fa-download"></i> Export Options</h3>
        <button class="close-export" onclick="showExportOptions()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="export-types">
        <button onclick="exportCSV()">
          <i class="fas fa-file-csv"></i> CSV
          <span>Comma separated values</span>
        </button>
        <button onclick="exportExcel()">
          <i class="fas fa-file-excel"></i> Excel
          <span>Full spreadsheet format</span>
        </button>
        <button onclick="printReport()">
          <i class="fas fa-print"></i> Print
          <span>Printer-friendly version</span>
        </button>
        <button onclick="exportSummary()">
          <i class="fas fa-file-alt"></i> Summary
          <span>Monthly report summary</span>
        </button>
        <button onclick="exportPDF()">
          <i class="fas fa-file-pdf"></i> PDF
          <span>Portable document format</span>
        </button>
      </div>
      
      <div class="export-range">
        <label>
          <input type="radio" name="exportRange" value="current" checked> Current Period
        </label>
        <label>
          <input type="radio" name="exportRange" value="all"> All Data
        </label>
        <label>
          <input type="radio" name="exportRange" value="custom"> Custom Range
        </label>
      </div>
    </div>
    
    <div class="holiday-info">
      <i class="fas fa-info-circle"></i>
      <p>Red markers indicate Singapore public holidays (2.0x pay). Saturday overtime: 1.5x, Sunday overtime: 2.0x</p>
    </div>
    
    <div class="calendar-container">
      <div class="weekdays">
        <div>Sunday</div>
        <div>Monday</div>
        <div>Tuesday</div>
        <div>Wednesday</div>
        <div>Thursday</div>
        <div>Friday</div>
        <div>Saturday</div>
      </div>
      
      <div id="calendar"></div>
    </div>
    
    <div class="stats">
      <div class="stat-card">
        <div class="label">Overtime Days</div>
        <div class="value" id="overtimeDays">0</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Overtime Hours</div>
        <div class="value" id="totalHours">0</div>
      </div>
      <div class="stat-card">
        <div class="label">Sat Overtime Hours</div>
        <div class="value" id="satHours">0</div>
      </div>
      <div class="stat-card">
        <div class="label">Sun Overtime Hours</div>
        <div class="value" id="sunHours">0</div>
      </div>
      <div class="stat-card">
        <div class="label">Late Arrivals</div>
        <div class="value" id="lateCount">0</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Late Minutes</div>
        <div class="value" id="lateMinutes">0</div>
      </div>
      <div class="stat-card late-deduction" id="lateDeductionCard">
        <div class="label">Late Deductions</div>
        <div class="value" id="lateDeduction">$0</div>
      </div>
      <div class="stat-card salary" id="salaryCard">
        <div class="label">Salary Estimate</div>
        <div class="value" id="monthSalary">$0</div>
      </div>
      <div class="stat-card allowance" id="allowanceCard">
        <div class="label">Allowance</div>
        <div class="value" id="totalAllowance">$0</div>
      </div>
    </div>
    
    <footer>
      <p>Â© 2025 Overtime Tracking System | Data stored locally in browser | Includes Singapore holidays 1993-2053</p>
    </footer>
  </div>

  <div id="notification"></div>
  <div class="overlay" id="overlay"></div>
  
  <!-- Edit Record Modal -->
  <div class="modal" id="editModal">
    <h3><i class="fas fa-edit"></i> <span id="editDateLabel"></span></h3>
    <label>Clock In Time</label>
    <input type="time" id="editStart">
    <label>Clock Out Time</label>
    <input type="time" id="editEnd">
    <div class="clock-buttons">
      <button id="saveBtn" onclick="saveEdit()">Save</button>
      <button id="deleteBtn" onclick="deleteRecord()">Delete</button>
      <button id="cancelBtn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
  
  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <h3><i class="fas fa-cog"></i> System Settings</h3>
    <label>Monthly Salary (SGD):</label>
    <input type="number" id="monthlySalary" min="0" step="100" value="5000">
    
    <label>Hourly Rate (SGD):</label>
    <input type="number" id="hourlyRate" min="0" step="1" value="30" readonly>
    
    <label>Late Penalty/min (SGD):</label>
    <input type="number" id="latePenalty" min="0" step="0.1" value="0.5">
    
    <label>Standard Start Time:</label>
    <input type="time" id="workStartTime" value="08:00">
    
    <label>Standard End Time:</label>
    <input type="time" id="workEndTime" value="17:30">
    
    <div class="clock-buttons">
      <button id="saveSettingsBtn" onclick="saveSettings()">Save Settings</button>
      <button id="cancelSettingsBtn" onclick="closeSettings()">Cancel</button>
    </div>
  </div>
  
  <!-- Allowance Management Modal -->
  <div class="modal" id="allowanceModal">
    <h3><i class="fas fa-money-bill-wave"></i> Allowance Management</h3>
    
    <div class="allowance-list" id="allowanceList">
      <div class="allowance-item">
        <span class="allowance-month">2023-11</span>
        <span class="allowance-amount">$100.00</span>
      </div>
      <div class="allowance-item">
        <span class="allowance-month">2023-12</span>
        <span class="allowance-amount">$150.00</span>
      </div>
      <div class="allowance-item">
        <span class="allowance-month">2024-01</span>
        <span class="allowance-amount">$200.00</span>
      </div>
    </div>
    
    <label>Month-Year (YYYY-MM):</label>
    <input type="month" id="allowanceMonth">
    
    <label>Allowance Amount (SGD):</label>
    <input type="number" id="allowanceAmount" min="-10000" max="10000" step="100" value="0">
    
    <div class="clock-buttons">
      <button id="addAllowanceBtn" onclick="addAllowance()">Add/Update</button>
      <button id="deleteAllowanceBtn" onclick="deleteAllowance()">Delete</button>
      <button onclick="closeAllowanceModal()">Cancel</button>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'worklog-records';
    const SETTINGS_KEY = 'worklog-settings';
    const UI_SETTINGS_KEY = 'worklog-ui-settings';
    const ALLOWANCE_KEY = 'worklog-allowances';
    const HOLIDAYS = generateSingaporeHolidays();
    let holidayViewEnabled = false;
    let clockedInToday = false;
    let clockedOutToday = false;
    let settings = {
      monthlySalary: 5000,
      latePenalty: 0.5,
      workStartTime: "08:00",
      workEndTime: "17:30"
    };
    
    let uiSettings = {
      salaryVisible: true
    };

    function generateSingaporeHolidays() {
      // Generate Singapore public holidays for 1993-2053
      const holidays = {};
      
      // Fixed date holidays
      for (let year = 1993; year <= 2053; year++) {
        // New Year
        holidays[`${year}-01-01`] = 'New Year';
        
        // Labour Day
        holidays[`${year}-05-01`] = 'Labour Day';
        
        // National Day
        holidays[`${year}-08-09`] = 'National Day';
        
        // Christmas
        holidays[`${year}-12-25`] = 'Christmas';
      }
      
      // Lunar New Year
      const lunarNewYears = {
        '1993': '1993-01-23', '1994': '1994-02-10', '1995': '1995-01-31', '1996': '1996-02-19', '1997': '1997-02-07',
        '1998': '1998-01-28', '1999': '1999-02-16', '2000': '2000-02-05', '2001': '2001-01-24', '2002': '2002-02-12',
        '2003': '2003-02-01', '2004': '2004-01-22', '2005': '2005-02-09', '2006': '2006-01-29', '2007': '2007-02-18',
        '2008': '2008-02-07', '2009': '2009-01-26', '2010': '2010-02-14', '2011': '2011-02-03', '2012': '2012-01-23',
        '2013': '2013-02-10', '2014': '2014-01-31', '2015': '2015-02-19', '2016': '2016-02-08', '2017': '2017-01-28',
        '2018': '2018-02-16', '2019': '2019-02-05', '2020': '2020-01-25', '2021': '2021-02-12', '2022': '2022-02-01',
        '2023': '2023-01-22', '2024': '2024-02-10', '2025': '2025-01-29', '2026': '2026-02-17', '2027': '2027-02-06',
        '2028': '2028-01-26', '2029': '2029-02-13', '2030': '2030-02-03', '2031': '2031-01-23', '2032': '2032-02-11',
        '2033': '2033-01-31', '2034': '2034-02-19', '2035': '2035-02-08', '2036': '2036-01-28', '2037': '2037-02-15',
        '2038': '2038-02-04', '2039': '2039-01-24', '2040': '2040-02-12', '2041': '2041-02-01', '2042': '2042-01-22',
        '2043': '2043-02-10', '2044': '2044-01-30', '2045': '2045-02-17', '2046': '2046-02-06', '2047': '2047-01-26',
        '2048': '2048-02-14', '2049': '2049-02-02', '2050': '2050-01-23', '2051': '2051-02-11', '2052': '2052-02-01',
        '2053': '2053-02-19'
      };
      
      // Add Lunar New Year (2 days)
      for (const [year, date] of Object.entries(lunarNewYears)) {
        const d1 = new Date(date);
        const d2 = new Date(d1);
        d2.setDate(d2.getDate() + 1);
        
        holidays[date] = 'Lunar New Year';
        holidays[formatDate(d2)] = 'Lunar New Year';
      }
      
      // Other important holidays
      const otherHolidays = {
        // Good Friday
        '2023-04-07': 'Good Friday',
        '2024-03-29': 'Good Friday',
        '2025-04-18': 'Good Friday',
        '2026-04-03': 'Good Friday',
        
        // Vesak Day
        '2023-05-08': 'Vesak Day',
        '2024-05-22': 'Vesak Day',
        '2025-05-12': 'Vesak Day',
        
        // Hari Raya Puasa
        '2023-06-02': 'Hari Raya Puasa',
        '2024-06-17': 'Hari Raya Puasa',
        '2025-06-06': 'Hari Raya Puasa',
        
        // Hari Raya Haji
        '2023-06-29': 'Hari Raya Haji',
        '2024-07-17': 'Hari Raya Haji',
        '2025-07-07': 'Hari Raya Haji',
        
        // Deepavali
        '2023-11-12': 'Deepavali',
        '2024-10-31': 'Deepavali',
        '2025-10-20': 'Deepavali'
      };
      
      // Add other holidays
      for (const [date, name] of Object.entries(otherHolidays)) {
        holidays[date] = name;
      }
      
      return holidays;
    }

    function getRecords() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    }

    function saveRecords(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    
    function getSettings() {
      const savedSettings = localStorage.getItem(SETTINGS_KEY);
      return savedSettings ? JSON.parse(savedSettings) : settings;
    }
    
    function getUISettings() {
      const savedUISettings = localStorage.getItem(UI_SETTINGS_KEY);
      return savedUISettings ? JSON.parse(savedUISettings) : uiSettings;
    }
    
    function getAllowances() {
      const savedAllowances = localStorage.getItem(ALLOWANCE_KEY);
      return savedAllowances ? JSON.parse(savedAllowances) : {};
    }
    
    function saveAllowances(data) {
      localStorage.setItem(ALLOWANCE_KEY, JSON.stringify(data));
    }
    
    function saveSettings() {
      settings.monthlySalary = parseFloat(document.getElementById('monthlySalary').value) || 5000;
      settings.latePenalty = parseFloat(document.getElementById('latePenalty').value) || 0.5;
      settings.workStartTime = document.getElementById('workStartTime').value || "08:00";
      settings.workEndTime = document.getElementById('workEndTime').value || "17:30";
      
      // Calculate hourly rate
      const hourlyRate = settings.monthlySalary / (22 * 8);
      document.getElementById('hourlyRate').value = hourlyRate.toFixed(2);
      
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      closeSettings();
      renderCalendar();
      calculateSalary();
      showNotification('System settings saved');
    }
    
    function saveUISettings() {
      localStorage.setItem(UI_SETTINGS_KEY, JSON.stringify(uiSettings));
    }

    function formatDate(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getCurrentTime() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    function getMonthDates(year, month) {
      const dates = [];
      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);
      const startDay = first.getDay();

      for (let i = 0; i < startDay; i++) {
        dates.push(null);
      }

      for (let i = 1; i <= last.getDate(); i++) {
        dates.push(new Date(year, month, i));
      }
      return dates;
    }
    
    function calculateOvertime(dateStr, start, end) {
      if (!start || !end) return 0;
      
      const [startHour, startMin] = start.split(':').map(Number);
      const [endHour, endMin] = end.split(':').map(Number);
      
      const startTotal = startHour * 60 + startMin;
      const endTotal = endHour * 60 + endMin;
      
      // Get date object
      const date = new Date(dateStr);
      const dayOfWeek = date.getDay();
      
      // For weekends, all work hours are considered overtime
      if (dayOfWeek === 0 || dayOfWeek === 6) {
        const totalMinutes = endTotal - startTotal;
        return totalMinutes / 60; // Return hours
      }
      
      // For weekdays: only calculate time after standard end time
      const [endHourWork, endMinWork] = settings.workEndTime.split(':').map(Number);
      const normalEndTime = endHourWork * 60 + endMinWork;
      
      const overtime = Math.max(0, endTotal - normalEndTime);
      return overtime / 60; // Convert to hours
    }
    
    function calculateLateMinutes(dateStr, startTime) {
      if (!startTime) return 0;
      
      // Get date object
      const date = new Date(dateStr);
      const dayOfWeek = date.getDay();
      
      // Weekends don't count for late arrivals
      if (dayOfWeek === 0 || dayOfWeek === 6) {
        return 0;
      }
      
      // Check if holiday
      if (HOLIDAYS[dateStr] !== undefined) {
        return 0;
      }
      
      const [startHour, startMin] = startTime.split(':').map(Number);
      const startTotal = startHour * 60 + startMin;
      
      // Start time
      const [startHourWork, startMinWork] = settings.workStartTime.split(':').map(Number);
      const onTime = startHourWork * 60 + startMinWork;
      
      // Late minutes
      return Math.max(0, startTotal - onTime);
    }
    
    function getPayPeriodDates(periodType, selectedMonth) {
      // Parse selected month
      const [year, month] = selectedMonth.split('-').map(Number);
      const baseDate = new Date(year, month - 1, 1);
      
      let startDate, endDate;
      
      if (periodType === 'current') {
        // Current period: 18th of previous month to 17th of current month
        startDate = new Date(year, month - 2, 18);
        endDate = new Date(year, month - 1, 17);
      } else if (periodType === 'last') {
        // Last period: 18th of previous-previous month to 17th of previous month
        startDate = new Date(year, month - 3, 18);
        endDate = new Date(year, month - 2, 17);
      } else {
        // Custom period (default to current)
        startDate = new Date(year, month - 2, 18);
        endDate = new Date(year, month - 1, 17);
      }
      
      // Ensure end date doesn't exceed today
      const today = new Date();
      if (endDate > today) endDate = today;
      
      return {
        start: startDate,
        end: endDate,
        display: `${formatDate(startDate)} to ${formatDate(endDate)}`
      };
    }

    function renderCalendar() {
      const picker = document.getElementById('monthPicker');
      const selectedMonth = picker.value;
      const [year, month] = selectedMonth.split('-').map(Number);
      const cal = document.getElementById('calendar');
      const data = getRecords();
      const today = new Date();
      const todayStr = formatDate(today);
      
      cal.innerHTML = '';
      const dates = getMonthDates(year, month - 1);
      
      let overtimeDays = 0;
      let totalHours = 0;
      let holidayDays = 0;
      let lateCount = 0;
      let totalLateMinutes = 0;
      let deductionAmount = 0;
      let satHours = 0;
      let sunHours = 0;

      dates.forEach(d => {
        const div = document.createElement('div');
        div.className = 'day';
        
        if (!d) {
          div.classList.add('inactive');
          cal.appendChild(div);
          return;
        }
        
        const dateStr = formatDate(d);
        const dayOfWeek = d.getDay();
        const isToday = dateStr === todayStr;
        const isSaturday = dayOfWeek === 6;
        const isSunday = dayOfWeek === 0;
        const isHoliday = HOLIDAYS[dateStr] !== undefined;
        
        if (isSaturday) {
          div.classList.add('saturday');
        } else if (isSunday) {
          div.classList.add('sunday');
        }
        
        if (isHoliday && holidayViewEnabled) {
          div.classList.add('holiday');
        }
        
        const rec = data.find(r => r.date === dateStr);
        const overtime = rec ? calculateOvertime(dateStr, rec.start, rec.end) : 0;
        const lateMinutes = rec ? calculateLateMinutes(dateStr, rec.start) : 0;
        
        if (overtime > 0) {
          overtimeDays++;
          totalHours += overtime;
          
          if (isSaturday) {
            satHours += overtime;
          } else if (isSunday) {
            sunHours += overtime;
          }
          
          if (isHoliday || isSaturday || isSunday) {
            holidayDays++;
          }
        }
        
        if (lateMinutes > 0) {
          lateCount++;
          totalLateMinutes += lateMinutes;
          deductionAmount += lateMinutes * settings.latePenalty;
        }
        
        let overtimeRate = '';
        if (isSaturday) {
          overtimeRate = '<span class="overtime-rate">1.5x</span>';
        } else if (isSunday) {
          overtimeRate = '<span class="overtime-rate">2.0x</span>';
        }
        
        div.innerHTML = `
          <div class="date-label">
            ${d.getDate()}
            ${isToday ? '<span class="current-indicator">T</span>' : ''}
            ${overtimeRate}
          </div>
        `;
        
        if (isHoliday && holidayViewEnabled) {
          div.innerHTML += `<div class="holiday-label">${HOLIDAYS[dateStr]}</div>`;
        }
        
        if (rec) {
          div.innerHTML += `
            <div class="record">
              <span>Start:</span>
              <span class="time">${rec.start || ''}</span>
            </div>
            <div class="record">
              <span>End:</span>
              <span class="time">${rec.end || ''}</span>
            </div>
          `;
          
          if (lateMinutes > 0) {
            div.innerHTML += `
              <div class="late">
                Late ${lateMinutes} min
              </div>
              <div class="deduction">
                Deduction $${(lateMinutes * settings.latePenalty).toFixed(2)}
              </div>
            `;
          }
          
          if (overtime > 0) {
            div.innerHTML += `
              <div class="overtime">
                Overtime ${overtime.toFixed(1)} hr
              </div>
            `;
          }
        }
        
        div.onclick = () => openModal(dateStr, rec);
        cal.appendChild(div);
      });
      
      // Update statistics
      document.getElementById('overtimeDays').textContent = overtimeDays;
      document.getElementById('totalHours').textContent = totalHours.toFixed(1);
      document.getElementById('satHours').textContent = satHours.toFixed(1);
      document.getElementById('sunHours').textContent = sunHours.toFixed(1);
      document.getElementById('lateCount').textContent = lateCount;
      document.getElementById('lateMinutes').textContent = totalLateMinutes;
      document.getElementById('lateDeduction').textContent = `$${deductionAmount.toFixed(2)}`;
      
      // Update pay period display
      const periodType = document.getElementById('payPeriodSelect').value;
      const period = getPayPeriodDates(periodType, selectedMonth);
      document.getElementById('payPeriodDates').textContent = period.display;
      
      // Update salary estimate
      calculateSalary();
    }

    function toggleHolidays() {
      holidayViewEnabled = !holidayViewEnabled;
      document.getElementById('holidayToggle').innerHTML = 
        holidayViewEnabled ? 
        '<i class="fas fa-calendar-day"></i> Standard View' : 
        '<i class="fas fa-calendar-day"></i> Holiday View';
      
      renderCalendar();
      showNotification(holidayViewEnabled ? 'Holiday view enabled' : 'Standard view enabled');
    }
    
    function toggleSalary() {
      uiSettings.salaryVisible = !uiSettings.salaryVisible;
      saveUISettings();
      
      const salaryCard = document.getElementById('salaryCard');
      const allowanceCard = document.getElementById('allowanceCard');
      const lateDeductionCard = document.getElementById('lateDeductionCard');
      
      salaryCard.style.display = uiSettings.salaryVisible ? 'block' : 'none';
      allowanceCard.style.display = uiSettings.salaryVisible ? 'block' : 'none';
      lateDeductionCard.style.display = uiSettings.salaryVisible ? 'block' : 'none';
      
      document.getElementById('salaryToggle').innerHTML = 
        uiSettings.salaryVisible ? 
        '<i class="fas fa-eye-slash"></i> Hide Salary' : 
        '<i class="fas fa-eye"></i> Show Salary';
      
      showNotification(uiSettings.salaryVisible ? 'Salary estimates visible' : 'Salary estimates hidden');
    }
    
    function showExportOptions() {
      const options = document.getElementById('exportOptions');
      options.style.display = options.style.display === 'flex' ? 'none' : 'flex';
    }

    let editingDate = '';

    function openModal(date, rec) {
      editingDate = date;
      document.getElementById('editDateLabel').textContent = `Edit: ${date}`;
      document.getElementById('editStart').value = rec?.start || '';
      document.getElementById('editEnd').value = rec?.end || '';
      document.getElementById('editModal').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }
    
    function openSettings() {
      const savedSettings = getSettings();
      document.getElementById('monthlySalary').value = savedSettings.monthlySalary;
      document.getElementById('latePenalty').value = savedSettings.latePenalty;
      document.getElementById('workStartTime').value = savedSettings.workStartTime;
      document.getElementById('workEndTime').value = savedSettings.workEndTime;
      
      // Calculate hourly rate
      const hourlyRate = savedSettings.monthlySalary / (22 * 8);
      document.getElementById('hourlyRate').value = hourlyRate.toFixed(2);
      
      document.getElementById('settingsModal').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }
    
    function closeSettings() {
      document.getElementById('settingsModal').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }
    
    function openAllowanceModal() {
      const allowances = getAllowances();
      const listEl = document.getElementById('allowanceList');
      listEl.innerHTML = '';
      
      // Add existing allowances
      Object.entries(allowances).forEach(([month, amount]) => {
        const item = document.createElement('div');
        item.className = 'allowance-item';
        item.innerHTML = `
          <span class="allowance-month">${month}</span>
          <span class="allowance-amount">$${amount.toFixed(2)}</span>
        `;
        listEl.appendChild(item);
      });
      
      // Set current month
      const currentMonth = document.getElementById('monthPicker').value;
      document.getElementById('allowanceMonth').value = currentMonth;
      
      // Reset amount
      document.getElementById('allowanceAmount').value = '0';
      
      // Show modal
      document.getElementById('allowanceModal').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }
    
    function closeAllowanceModal() {
      document.getElementById('allowanceModal').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }
    
    function addAllowance() {
      const month = document.getElementById('allowanceMonth').value;
      const amount = parseFloat(document.getElementById('allowanceAmount').value) || 0;
      
      if (!month) {
        showNotification('Please select a month');
        return;
      }
      
      const allowances = getAllowances();
      allowances[month] = amount;
      saveAllowances(allowances);
      
      // Update allowance list
      const listEl = document.getElementById('allowanceList');
      const existingItem = Array.from(listEl.children).find(item => 
        item.querySelector('.allowance-month').textContent === month
      );
      
      if (existingItem) {
        existingItem.querySelector('.allowance-amount').textContent = `$${amount.toFixed(2)}`;
      } else {
        const newItem = document.createElement('div');
        newItem.className = 'allowance-item';
        newItem.innerHTML = `
          <span class="allowance-month">${month}</span>
          <span class="allowance-amount">$${amount.toFixed(2)}</span>
        `;
        listEl.appendChild(newItem);
      }
      
      // Recalculate salary
      calculateSalary();
      showNotification(`Allowance for ${month} updated: $${amount.toFixed(2)}`);
    }
    
    function deleteAllowance() {
      const month = document.getElementById('allowanceMonth').value;
      
      if (!month) {
        showNotification('Please select a month');
        return;
      }
      
      const allowances = getAllowances();
      if (allowances.hasOwnProperty(month)) {
        delete allowances[month];
        saveAllowances(allowances);
        
        // Remove from list
        const listEl = document.getElementById('allowanceList');
        const items = Array.from(listEl.children);
        const itemToRemove = items.find(item => 
          item.querySelector('.allowance-month').textContent === month
        );
        
        if (itemToRemove) {
          listEl.removeChild(itemToRemove);
        }
        
        // Recalculate salary
        calculateSalary();
        showNotification(`Allowance for ${month} deleted`);
      } else {
        showNotification(`No allowance found for ${month}`);
      }
    }

    function saveEdit() {
      const start = document.getElementById('editStart').value;
      const end = document.getElementById('editEnd').value;
      const records = getRecords();
      let rec = records.find(r => r.date === editingDate);
      if (!rec) {
        rec = { date: editingDate };
        records.push(rec);
      }
      rec.start = start;
      rec.end = end;
      saveRecords(records);
      closeModal();
      renderCalendar();
      showNotification('Record saved');
    }

    function deleteRecord() {
      let records = getRecords();
      records = records.filter(r => r.date !== editingDate);
      saveRecords(records);
      closeModal();
      renderCalendar();
      showNotification('Record deleted');
    }

    function clockIn() {
      if (clockedInToday) {
        showNotification('You have already clocked in today');
        return;
      }
      
      const now = new Date();
      const dateStr = formatDate(now);
      const timeStr = getCurrentTime();
      
      const records = getRecords();
      let rec = records.find(r => r.date === dateStr);
      if (!rec) {
        rec = { date: dateStr };
        records.push(rec);
      }
      
      // Record clock in
      rec.start = timeStr;
      saveRecords(records);
      renderCalendar();
      
      // Calculate late minutes (weekends and holidays not counted)
      const lateMinutes = calculateLateMinutes(dateStr, timeStr);
      
      if (lateMinutes > 0) {
        showNotification(`Clock in successful: ${timeStr} | Late ${lateMinutes} min | Deduction $${(lateMinutes * settings.latePenalty).toFixed(2)}`);
      } else {
        showNotification(`Clock in successful: ${timeStr} | On time`);
      }
      
      clockedInToday = true;
    }

    function clockOut() {
      if (clockedOutToday) {
        showNotification('You have already clocked out today');
        return;
      }
      
      const now = new Date();
      const dateStr = formatDate(now);
      const timeStr = getCurrentTime();
      
      const records = getRecords();
      let rec = records.find(r => r.date === dateStr);
      if (!rec) {
        rec = { date: dateStr };
        records.push(rec);
      }
      
      // Check if clocked in
      if (!rec.start) {
        showNotification('Please clock in first');
        return;
      }
      
      rec.end = timeStr;
      saveRecords(records);
      renderCalendar();
      
      const overtime = calculateOvertime(dateStr, rec.start, rec.end);
      showNotification(`Clock out successful: ${timeStr} | Overtime: ${overtime.toFixed(1)} hours`);
      
      clockedOutToday = true;
    }

    function calculateSalary() {
      const periodType = document.getElementById('payPeriodSelect').value;
      const selectedMonth = document.getElementById('monthPicker').value;
      const period = getPayPeriodDates(periodType, selectedMonth);
      
      const settings = getSettings();
      const monthlySalary = settings.monthlySalary;
      const latePenalty = settings.latePenalty;
      
      // Calculate hourly rate (22 work days, 8 hours per day)
      const hourlyRate = monthlySalary / (22 * 8);
      
      // Get records
      const records = getRecords().filter(r => {
        const recordDate = new Date(r.date);
        return recordDate >= period.start && recordDate <= period.end;
      });
      
      let overtimePay = 0;
      let lateDeduction = 0;
      
      // Calculate period data
      records.forEach(r => {
        const recordDate = new Date(r.date);
        const isHoliday = HOLIDAYS[r.date] !== undefined;
        const dayOfWeek = recordDate.getDay();
        const isSaturday = dayOfWeek === 6;
        const isSunday = dayOfWeek === 0;
        
        // Calculate overtime pay
        const overtime = calculateOvertime(r.date, r.start, r.end);
        if (overtime > 0) {
          if (isHoliday || isSunday) {
            // Holiday or Sunday: 2.0x pay
            overtimePay += overtime * hourlyRate * 2;
          } else if (isSaturday) {
            // Saturday: 1.5x pay
            overtimePay += overtime * hourlyRate * 1.5;
          } else {
            // Weekday: 1.5x pay
            overtimePay += overtime * hourlyRate * 1.5;
          }
        }
        
        // Calculate late deductions (weekends and holidays not counted)
        const lateMinutes = calculateLateMinutes(r.date, r.start);
        lateDeduction += lateMinutes * latePenalty;
      });
      
      // Get allowances
      const allowances = getAllowances();
      let totalAllowance = 0;
      
      // Calculate allowances for the period
      Object.entries(allowances).forEach(([month, amount]) => {
        const allowanceMonth = new Date(`${month}-01`);
        if (allowanceMonth >= period.start && allowanceMonth <= period.end) {
          totalAllowance += amount;
        }
      });
      
      // Update allowance display
      document.getElementById('totalAllowance').textContent = `$${totalAllowance.toFixed(2)}`;
      
      // Calculate total salary
      const totalSalary = monthlySalary + overtimePay - lateDeduction + totalAllowance;
      
      // Update UI
      document.getElementById('monthSalary').textContent = `$${totalSalary.toFixed(2)}`;
      document.getElementById('lateDeduction').textContent = `$${lateDeduction.toFixed(2)}`;
      
      // Only show notification if salary is visible
      if (uiSettings.salaryVisible) {
        showNotification(`Salary calculated: Base $${monthlySalary} + Overtime $${overtimePay.toFixed(2)} - Deductions $${lateDeduction.toFixed(2)} + Allowance $${totalAllowance.toFixed(2)} = Total $${totalSalary.toFixed(2)}`);
      }
    }

    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
      notification.style.display = 'flex';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
    }

    // ================== å¯¼åºåè½å®ç° ==================
    function getExportData() {
      const periodType = document.getElementById('payPeriodSelect').value;
      const selectedMonth = document.getElementById('monthPicker').value;
      const period = getPayPeriodDates(periodType, selectedMonth);
      
      const settings = getSettings();
      const records = getRecords().filter(r => {
        const recordDate = new Date(r.date);
        return recordDate >= period.start && recordDate <= period.end;
      });
      
      // åå¤ç»è®¡æ°æ®
      let overtimeDays = 0;
      let totalHours = 0;
      let satHours = 0;
      let sunHours = 0;
      let lateCount = 0;
      let totalLateMinutes = 0;
      let deductionAmount = 0;
      let holidayDays = 0;
      
      records.forEach(r => {
        const date = new Date(r.date);
        const isHoliday = HOLIDAYS[r.date] !== undefined;
        const isSaturday = date.getDay() === 6;
        const isSunday = date.getDay() === 0;
        
        const overtime = calculateOvertime(r.date, r.start, r.end);
        const lateMinutes = calculateLateMinutes(r.date, r.start);
        
        if (overtime > 0) {
          overtimeDays++;
          totalHours += overtime;
          
          if (isSaturday) satHours += overtime;
          if (isSunday) sunHours += overtime;
          if (isHoliday || isSaturday || isSunday) holidayDays++;
        }
        
        if (lateMinutes > 0) {
          lateCount++;
          totalLateMinutes += lateMinutes;
          deductionAmount += lateMinutes * settings.latePenalty;
        }
      });
      
      return {
        period: period.display,
        records: records,
        stats: {
          overtimeDays,
          totalHours: totalHours.toFixed(1),
          satHours: satHours.toFixed(1),
          sunHours: sunHours.toFixed(1),
          lateCount,
          totalLateMinutes,
          deductionAmount: deductionAmount.toFixed(2)
        }
      };
    }
    
    function exportCSV() {
      const data = getExportData();
      let csvContent = "Date,Start Time,End Time,Overtime (hr),Late (min),Deduction (SGD),Holiday\n";
      
      data.records.forEach(record => {
        const date = new Date(record.date);
        const isHoliday = HOLIDAYS[record.date] !== undefined;
        const overtime = calculateOvertime(record.date, record.start, record.end);
        const lateMinutes = calculateLateMinutes(record.date, record.start);
        const deduction = (lateMinutes * settings.latePenalty).toFixed(2);
        
        csvContent += `"${record.date}","${record.start || ''}","${record.end || ''}",`;
        csvContent += `"${overtime.toFixed(1)}","${lateMinutes}","${deduction}",`;
        csvContent += `"${isHoliday ? HOLIDAYS[record.date] : ''}"\n`;
      });
      
      // æ·»å ç»è®¡æ°æ®
      csvContent += "\n\nSummary\n";
      csvContent += `Period,${data.period}\n`;
      csvContent += `Overtime Days,${data.stats.overtimeDays}\n`;
      csvContent += `Total Overtime Hours,${data.stats.totalHours}\n`;
      csvContent += `Saturday Hours,${data.stats.satHours}\n`;
      csvContent += `Sunday Hours,${data.stats.sunHours}\n`;
      csvContent += `Late Arrivals,${data.stats.lateCount}\n`;
      csvContent += `Total Late Minutes,${data.stats.totalLateMinutes}\n`;
      csvContent += `Late Deductions,$${data.stats.deductionAmount}\n`;
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `overtime_report_${new Date().toISOString().slice(0,10)}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showNotification('CSV file downloaded successfully');
      showExportOptions();
    }
    
    function exportExcel() {
      const data = getExportData();
      
      // åå»ºå·¥ä½ç°¿
      const wb = XLSX.utils.book_new();
      wb.Props = {
        Title: "Overtime Report",
        Subject: "Singapore Overtime Tracking",
        Author: "Overtime Tracking System",
        CreatedDate: new Date()
      };
      
      // æ·»å è®°å½è¡¨
      const ws_data = [
        ["Date", "Start Time", "End Time", "Overtime (hr)", "Late (min)", "Deduction (SGD)", "Holiday"]
      ];
      
      data.records.forEach(record => {
        const date = new Date(record.date);
        const isHoliday = HOLIDAYS[record.date] !== undefined;
        const overtime = calculateOvertime(record.date, record.start, record.end);
        const lateMinutes = calculateLateMinutes(record.date, record.start);
        const deduction = (lateMinutes * settings.latePenalty).toFixed(2);
        
        ws_data.push([
          record.date,
          record.start || '',
          record.end || '',
          overtime.toFixed(1),
          lateMinutes,
          deduction,
          isHoliday ? HOLIDAYS[record.date] : ''
        ]);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.book_append_sheet(wb, ws, "Records");
      
      // æ·»å ç»è®¡è¡¨
      const summary_data = [
        ["Period", data.period],
        ["Overtime Days", data.stats.overtimeDays],
        ["Total Overtime Hours", data.stats.totalHours],
        ["Saturday Hours", data.stats.satHours],
        ["Sunday Hours", data.stats.sunHours],
        ["Late Arrivals", data.stats.lateCount],
        ["Total Late Minutes", data.stats.totalLateMinutes],
        ["Late Deductions", `$${data.stats.deductionAmount}`]
      ];
      
      const ws_summary = XLSX.utils.aoa_to_sheet(summary_data);
      XLSX.utils.book_append_sheet(wb, ws_summary, "Summary");
      
      // å¯¼åºæä»¶
      XLSX.writeFile(wb, `overtime_report_${new Date().toISOString().slice(0,10)}.xlsx`);
      showNotification('Excel file downloaded successfully');
      showExportOptions();
    }
    
    function exportSummary() {
      const data = getExportData();
      let summaryContent = `Overtime Tracking Report\n`;
      summaryContent += `Period: ${data.period}\n`;
      summaryContent += `Generated: ${new Date().toLocaleString()}\n\n`;
      
      summaryContent += `===== Summary =====\n`;
      summaryContent += `Overtime Days: ${data.stats.overtimeDays}\n`;
      summaryContent += `Total Overtime Hours: ${data.stats.totalHours}\n`;
      summaryContent += `Saturday Hours: ${data.stats.satHours}\n`;
      summaryContent += `Sunday Hours: ${data.stats.sunHours}\n`;
      summaryContent += `Late Arrivals: ${data.stats.lateCount}\n`;
      summaryContent += `Total Late Minutes: ${data.stats.totalLateMinutes}\n`;
      summaryContent += `Late Deductions: $${data.stats.deductionAmount}\n\n`;
      
      summaryContent += `===== Detailed Records =====\n`;
      data.records.forEach(record => {
        const date = new Date(record.date);
        const isHoliday = HOLIDAYS[record.date] !== undefined;
        const overtime = calculateOvertime(record.date, record.start, record.end);
        const lateMinutes = calculateLateMinutes(record.date, record.start);
        const deduction = (lateMinutes * settings.latePenalty).toFixed(2);
        
        summaryContent += `Date: ${record.date}\n`;
        summaryContent += `  Start: ${record.start || 'N/A'}\n`;
        summaryContent += `  End: ${record.end || 'N/A'}\n`;
        summaryContent += `  Overtime: ${overtime.toFixed(1)} hr\n`;
        summaryContent += `  Late: ${lateMinutes} min\n`;
        summaryContent += `  Deduction: $${deduction}\n`;
        if (isHoliday) {
          summaryContent += `  Holiday: ${HOLIDAYS[record.date]}\n`;
        }
        summaryContent += `--------------------------------\n`;
      });
      
      const blob = new Blob([summaryContent], { type: 'text/plain;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `overtime_summary_${new Date().toISOString().slice(0,10)}.txt`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showNotification('Summary file downloaded successfully');
      showExportOptions();
    }
    
    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const data = getExportData();
      const currentDate = new Date().toLocaleDateString();
      
      // æ·»å æ é¢
      doc.setFontSize(18);
      doc.text("Overtime Tracking Report", 105, 15, null, null, 'center');
      doc.setFontSize(12);
      doc.text(`Period: ${data.period} | Generated: ${currentDate}`, 105, 22, null, null, 'center');
      
      // æ·»å æè¦
      doc.setFontSize(14);
      doc.text("Summary", 14, 30);
      
      const summaryY = 37;
      doc.setFontSize(11);
      doc.text(`Overtime Days: ${data.stats.overtimeDays}`, 20, summaryY);
      doc.text(`Total Overtime Hours: ${data.stats.totalHours}`, 20, summaryY + 7);
      doc.text(`Saturday Hours: ${data.stats.satHours}`, 20, summaryY + 14);
      doc.text(`Sunday Hours: ${data.stats.sunHours}`, 20, summaryY + 21);
      doc.text(`Late Arrivals: ${data.stats.lateCount}`, 100, summaryY);
      doc.text(`Total Late Minutes: ${data.stats.totalLateMinutes}`, 100, summaryY + 7);
      doc.text(`Late Deductions: $${data.stats.deductionAmount}`, 100, summaryY + 14);
      
      // æ·»å è¯¦ç»è®°å½æ é¢
      doc.setFontSize(14);
      doc.text("Detailed Records", 14, summaryY + 35);
      
      // åå¤è¡¨æ ¼æ°æ®
      const tableData = [];
      data.records.forEach(record => {
        const date = new Date(record.date);
        const isHoliday = HOLIDAYS[record.date] !== undefined;
        const overtime = calculateOvertime(record.date, record.start, record.end);
        const lateMinutes = calculateLateMinutes(record.date, record.start);
        const deduction = (lateMinutes * settings.latePenalty).toFixed(2);
        
        tableData.push([
          record.date,
          record.start || 'N/A',
          record.end || 'N/A',
          overtime.toFixed(1),
          lateMinutes,
          `$${deduction}`,
          isHoliday ? HOLIDAYS[record.date] : '-'
        ]);
      });
      
      // æ·»å è¡¨æ ¼
      doc.autoTable({
        startY: summaryY + 40,
        head: [['Date', 'Start', 'End', 'Overtime (hr)', 'Late (min)', 'Deduction', 'Holiday']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [67, 97, 238] },
        styles: { fontSize: 10 }
      });
      
      // æ·»å é¡µè
      const pageCount = doc.internal.getNumberOfPages();
      for(let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(10);
        doc.text(`Page ${i} of ${pageCount}`, 195, 285, null, null, 'right');
        doc.text("Singapore Overtime Tracking System", 15, 285);
      }
      
      // ä¿å­æä»¶
      doc.save(`overtime_report_${new Date().toISOString().slice(0,10)}.pdf`);
      showNotification('PDF file generated successfully');
      showExportOptions();
    }
    
    function printReport() {
      const data = getExportData();
      const currentDate = new Date().toLocaleString();
      
      // åå»ºæå°åå®¹
      let printContent = `
        <style>
          body { font-family: Arial, sans-serif; margin: 1cm; }
          h1 { text-align: center; margin-bottom: 5px; }
          .subtitle { text-align: center; margin-bottom: 20px; }
          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #4361ee; color: white; }
          .summary { margin-top: 30px; }
          .summary h2 { border-bottom: 1px solid #333; padding-bottom: 5px; }
          .summary-item { margin-bottom: 5px; }
          .page-break { page-break-before: always; }
          @media print {
            .no-print { display: none; }
          }
        </style>
        <div class="no-print" style="text-align:center;margin-bottom:20px;">
          <button onclick="window.print()" style="padding:10px 20px;background:#4361ee;color:white;border:none;border-radius:5px;cursor:pointer;">Print Report</button>
          <button onclick="window.close()" style="padding:10px 20px;background:#f72585;color:white;border:none;border-radius:5px;cursor:pointer;margin-left:10px;">Close</button>
        </div>
        <h1>Overtime Tracking Report</h1>
        <div class="subtitle">
          <p>Period: ${data.period} | Generated: ${currentDate}</p>
        </div>
      `;
      
      // æ·»å æè¦é¨å
      printContent += `
        <div class="summary">
          <h2>Summary</h2>
          <div class="summary-item"><strong>Overtime Days:</strong> ${data.stats.overtimeDays}</div>
          <div class="summary-item"><strong>Total Overtime Hours:</strong> ${data.stats.totalHours}</div>
          <div class="summary-item"><strong>Saturday Hours:</strong> ${data.stats.satHours}</div>
          <div class="summary-item"><strong>Sunday Hours:</strong> ${data.stats.sunHours}</div>
          <div class="summary-item"><strong>Late Arrivals:</strong> ${data.stats.lateCount}</div>
          <div class="summary-item"><strong>Total Late Minutes:</strong> ${data.stats.totalLateMinutes}</div>
          <div class="summary-item"><strong>Late Deductions:</strong> $${data.stats.deductionAmount}</div>
        </div>
      `;
      
      // æ·»å è¯¦ç»è®°å½
      printContent += `
        <div class="records" style="margin-top: 30px;">
          <h2>Detailed Records</h2>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Start</th>
                <th>End</th>
                <th>Overtime (hr)</th>
                <th>Late (min)</th>
                <th>Deduction</th>
                <th>Holiday</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      data.records.forEach(record => {
        const date = new Date(record.date);
        const isHoliday = HOLIDAYS[record.date] !== undefined;
        const overtime = calculateOvertime(record.date, record.start, record.end);
        const lateMinutes = calculateLateMinutes(record.date, record.start);
        const deduction = (lateMinutes * settings.latePenalty).toFixed(2);
        
        printContent += `
          <tr>
            <td>${record.date}</td>
            <td>${record.start || 'N/A'}</td>
            <td>${record.end || 'N/A'}</td>
            <td>${overtime.toFixed(1)}</td>
            <td>${lateMinutes}</td>
            <td>$${deduction}</td>
            <td>${isHoliday ? HOLIDAYS[record.date] : '-'}</td>
          </tr>
        `;
      });
      
      printContent += `
            </tbody>
          </table>
        </div>
      `;
      
      // åå»ºæå°çªå£
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Overtime Report</title>
          </head>
          <body>
            ${printContent}
          </body>
        </html>
      `);
      printWindow.document.close();
      
      showNotification('Print view opened in new window');
      showExportOptions();
    }
    
    function updatePayPeriod() {
      const selectedMonth = document.getElementById('monthPicker').value;
      const periodType = document.getElementById('payPeriodSelect').value;
      const period = getPayPeriodDates(periodType, selectedMonth);
      document.getElementById('payPeriodDates').textContent = period.display;
      renderCalendar();
    }
    
    function adjustPeriod(direction) {
      const picker = document.getElementById('monthPicker');
      const currentDate = new Date(picker.value + '-01');
      
      if (direction === -1) {
        currentDate.setMonth(currentDate.getMonth() - 1);
      } else {
        currentDate.setMonth(currentDate.getMonth() + 1);
      }
      
      const year = currentDate.getFullYear();
      const month = String(currentDate.getMonth() + 1).padStart(2, '0');
      picker.value = `${year}-${month}`;
      
      updatePayPeriod();
      showNotification(`Viewing data for ${year}-${month}`);
    }
    
    function applyCustomPeriod() {
      showNotification('Custom period applied');
      updatePayPeriod();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      const currentMonth = now.toISOString().slice(0,7);
      document.getElementById('monthPicker').value = currentMonth;
      
      // Load settings
      const savedSettings = getSettings();
      settings = savedSettings;
      
      // Load UI settings
      const savedUISettings = getUISettings();
      uiSettings = savedUISettings;
      
      // Initialize pay period
      const periodType = document.getElementById('payPeriodSelect').value;
      const period = getPayPeriodDates(periodType, currentMonth);
      document.getElementById('payPeriodDates').textContent = period.display;
      
      // Set salary visibility
      document.getElementById('salaryToggle').innerHTML = 
        uiSettings.salaryVisible ? 
        '<i class="fas fa-eye-slash"></i> Hide Salary' : 
        '<i class="fas fa-eye"></i> Show Salary';
      
      document.getElementById('salaryCard').style.display = 
        uiSettings.salaryVisible ? 'block' : 'none';
      
      document.getElementById('allowanceCard').style.display = 
        uiSettings.salaryVisible ? 'block' : 'none';
      
      document.getElementById('lateDeductionCard').style.display = 
        uiSettings.salaryVisible ? 'block' : 'none';
      
      renderCalendar();
      
      // Listen for month picker changes
      document.getElementById('monthPicker').addEventListener('change', function() {
        renderCalendar();
      });
      
      // Bind clock buttons
      document.getElementById('clockInBtn').addEventListener('click', clockIn);
      document.getElementById('clockOutBtn').addEventListener('click', clockOut);
      
      // Bind pay period selection
      document.getElementById('payPeriodSelect').addEventListener('change', function() {
        const selectedMonth = document.getElementById('monthPicker').value;
        const period = getPayPeriodDates(this.value, selectedMonth);
        document.getElementById('payPeriodDates').textContent = period.display;
        renderCalendar();
      });
      
      // Initialize salary calculation
      calculateSalary();
      
      // Reset daily clock status
      setInterval(() => {
        const now = new Date();
        if (now.getHours() === 0 && now.getMinutes() === 0) {
          clockedInToday = false;
          clockedOutToday = false;
        }
      }, 60000); // Check every minute
    });
  </script>
</body>
</html>
