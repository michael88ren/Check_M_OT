<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>加班打卡系统 - 新加坡版</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #2ec4b6;
      --light: #f8f9fa;
      --dark: #212529;
      --holiday: #ff6b6b;
      --weekend: #f8f9fa;
      --today: #ffd166;
      --gray: #adb5bd;
      --overtime: #4caf50;
      --late: #ff9800;
      --deduction: #e91e63;
      --saturday: #e3f2fd;
      --sunday: #ffecb3;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e0f7fa 0%, #f5f5f5 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }
    
    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 25px 30px;
      text-align: center;
      position: relative;
    }
    
    h1 {
      font-size: 2.4rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      max-width: 600px;
      margin: 0 auto;
    }
    
    #controls {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      padding: 20px;
      background: white;
      border-bottom: 1px solid #eee;
      gap: 15px;
      background: #f8fafc;
    }
    
    .control-group {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
    }
    
    button, select, input[type=month], input[type=number] {
      margin: 0;
      padding: 12px 20px;
      font-size: 15px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    input[type=month], input[type=number] {
      background: white;
      border: 1px solid #ddd;
      padding: 11px 18px;
      min-width: 180px;
    }
    
    input[type=number] {
      width: 120px;
    }
    
    button:active {
      transform: translateY(2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    #exportBtn {
      background: var(--info);
      color: white;
    }
    
    #clockInBtn {
      background: var(--primary);
      color: white;
    }
    
    #clockOutBtn {
      background: var(--secondary);
      color: white;
    }
    
    #holidayToggle {
      background: var(--warning);
      color: white;
    }
    
    #settingsBtn {
      background: #6c757d;
      color: white;
    }
    
    .calendar-container {
      padding: 0 20px 20px;
    }
    
    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: var(--primary);
      color: white;
      text-align: center;
      font-weight: 600;
      padding: 15px 0;
      border-radius: 12px 12px 0 0;
      margin-top: 20px;
    }
    
    .weekdays div {
      padding: 8px;
    }
    
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: #e0e6ed;
      border-radius: 0 0 12px 12px;
      overflow: hidden;
    }
    
    .day {
      background: white;
      min-height: 150px;
      padding: 15px 12px;
      font-size: 14px;
      position: relative;
      display: flex;
      flex-direction: column;
      transition: all 0.2s ease;
    }
    
    .day:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      z-index: 2;
    }
    
    .day.inactive {
      background: #f8fafc;
      color: #cbd5e1;
    }
    
    .day.saturday {
      background: var(--saturday);
    }
    
    .day.sunday {
      background: var(--sunday);
    }
    
    .day.holiday {
      background: #fff9f9;
      border-left: 4px solid var(--holiday);
    }
    
    .day.holiday .date-label {
      color: var(--holiday);
    }
    
    .day .date-label {
      font-weight: bold;
      font-size: 16px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .day .current-indicator {
      background-color: var(--primary);
      color: white;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    .day .overtime-rate {
      background: #ff9800;
      color: white;
      border-radius: 12px;
      padding: 2px 8px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .day .holiday-label {
      background: var(--holiday);
      color: white;
      border-radius: 20px;
      padding: 4px 10px;
      font-size: 12px;
      margin-top: 5px;
      display: inline-block;
      font-weight: 500;
    }
    
    .day .record {
      font-size: 13px;
      padding: 8px 10px;
      background: #f1f8ff;
      border-radius: 8px;
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
    }
    
    .day .record .time {
      font-weight: 600;
      color: var(--primary);
    }
    
    .day.holiday .record {
      background: #fff0f0;
    }
    
    .day .overtime {
      background: #e8f5e9;
      color: var(--overtime);
      font-weight: 600;
      margin-top: 10px;
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      font-size: 13px;
    }
    
    .day .late {
      background: #fff3e0;
      color: var(--late);
      font-weight: 600;
      margin-top: 8px;
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      font-size: 12px;
    }
    
    .day .deduction {
      background: #fce4ec;
      color: var(--deduction);
      font-weight: 600;
      margin-top: 8px;
      padding: 6px;
      border-radius: 6px;
      text-align: center;
      font-size: 12px;
    }
    
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ddd;
      padding: 30px;
      z-index: 1000;
      display: none;
      width: 420px;
      max-width: 90%;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.25);
    }
    
    .modal h3 {
      margin-bottom: 25px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.5rem;
    }
    
    .modal label {
      display: block;
      margin: 20px 0 10px;
      font-weight: 600;
      color: #555;
      font-size: 16px;
    }
    
    .modal input[type="time"], .modal input[type="number"] {
      display: block;
      width: 100%;
      padding: 14px 18px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 12px;
      background: #f8f9fa;
      font-weight: 500;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      display: none;
    }
    
    .clock-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }
    
    .clock-buttons button {
      flex: 1;
      padding: 14px;
      font-size: 16px;
    }
    
    #saveBtn {
      background: var(--primary);
      color: white;
    }
    
    #deleteBtn {
      background: var(--danger);
      color: white;
    }
    
    #cancelBtn {
      background: #6c757d;
      color: white;
    }
    
    #notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: var(--primary);
      color: white;
      padding: 18px 28px;
      border-radius: 14px;
      display: none;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      max-width: 380px;
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 16px;
      font-weight: 500;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      padding: 20px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
    }
    
    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card .value {
      font-size: 2.2rem;
      font-weight: 700;
      margin: 10px 0;
    }
    
    .stat-card .label {
      font-size: 1rem;
      color: #6c757d;
      font-weight: 500;
    }
    
    .stat-card.late-deduction {
      background: #fce4ec;
    }
    
    .stat-card.late-deduction .value {
      color: #e91e63;
    }
    
    .stat-card.salary {
      background: #e8f5e9;
    }
    
    .stat-card.salary .value {
      color: #4caf50;
    }
    
    footer {
      text-align: center;
      padding: 25px;
      color: #6c757d;
      font-size: 1rem;
      background: #f8f9fa;
      border-top: 1px solid #eee;
    }
    
    .holiday-info {
      background: #fff9f9;
      border: 1px solid #ffebee;
      border-radius: 12px;
      padding: 15px 20px;
      margin: 0 20px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .holiday-info i {
      color: var(--holiday);
      font-size: 24px;
    }
    
    .holiday-info p {
      font-size: 15px;
      color: #d32f2f;
    }
    
    .salary-settings {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      background: #e3f2fd;
      padding: 15px 20px;
      border-radius: 12px;
      margin: 0 20px 20px;
      align-items: center;
    }
    
    .salary-settings label {
      display: flex;
      flex-direction: column;
      font-weight: 500;
      font-size: 14px;
      color: #1565c0;
    }
    
    .salary-settings input {
      margin-top: 5px;
    }
    
    .export-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      background: #e8f5e9;
      padding: 15px 20px;
      border-radius: 12px;
      margin: 0 20px 20px;
    }
    
    .export-options button {
      background: var(--info);
      color: white;
    }
    
    .pay-period-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 15px 20px;
      background: #fff8e1;
      border-radius: 12px;
      margin: 0 20px 20px;
    }
    
    .pay-period-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .pay-period-label {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .pay-period-label i {
      color: #ff9800;
      font-size: 18px;
    }
    
    .pay-period {
      display: flex;
      align-items: center;
      gap: 10px;
      background: white;
      padding: 8px 15px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .pay-period select {
      background: white;
      border: 1px solid #ddd;
      padding: 8px 15px;
      border-radius: 8px;
    }
    
    .period-explanation {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
      padding: 0 5px;
    }
    
    @media (max-width: 768px) {
      #controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .control-group {
        flex-direction: column;
      }
      
      .control-group button {
        width: 100%;
      }
      
      .day {
        min-height: 120px;
      }
      
      .stats {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
      
      .salary-settings {
        flex-direction: column;
        align-items: stretch;
      }
      
      .pay-period-row {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    
    @media (max-width: 480px) {
      h1 {
        font-size: 1.8rem;
      }
      
      .weekdays div {
        padding: 5px 0;
        font-size: 13px;
      }
      
      .day {
        min-height: 110px;
        padding: 10px 8px;
      }
      
      .day .date-label {
        font-size: 14px;
      }
      
      .stat-card {
        padding: 15px;
      }
      
      .stat-card .value {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1><i class="fas fa-calendar-alt"></i> 加班打卡系统 - 新加坡版</h1>
      <p class="subtitle">记录考勤、加班时间及薪资计算（周末全天加班1.5倍/2.0倍）</p>
    </header>
    
    <div id="controls">
      <div class="control-group">
        <input type="month" id="monthPicker">
        <button id="exportBtn" onclick="showExportOptions()">
          <i class="fas fa-file-export"></i> 导出数据
        </button>
        <button id="settingsBtn" onclick="openSettings()">
          <i class="fas fa-cog"></i> 系统设置
        </button>
      </div>
      <div class="control-group">
        <button id="clockInBtn">
          <i class="fas fa-sign-in-alt"></i> 上班打卡
        </button>
        <button id="clockOutBtn">
          <i class="fas fa-sign-out-alt"></i> 下班打卡
        </button>
        <button id="holidayToggle" onclick="toggleHolidays()">
          <i class="fas fa-calendar-day"></i> 假期视图
        </button>
      </div>
    </div>
    
    <div class="pay-period-container">
      <div class="pay-period-row">
        <div class="pay-period-label">
          <i class="fas fa-info-circle"></i>
          <span>当前薪资周期:</span>
        </div>
        <div class="pay-period">
          <select id="payPeriodSelect">
            <option value="current">本月周期</option>
            <option value="last">上月周期</option>
            <option value="custom">自定义周期</option>
          </select>
          <span id="payPeriodDates"></span>
        </div>
      </div>
      <div class="period-explanation">
        薪资周期基于选择的月份自动计算：本月周期 = 上月18日 - 本月17日
      </div>
    </div>
    
    <div class="export-options" id="exportOptions" style="display: none;">
      <button onclick="exportCSV()">
        <i class="fas fa-file-csv"></i> 导出CSV
      </button>
      <button onclick="exportExcel()">
        <i class="fas fa-file-excel"></i> 导出Excel
      </button>
      <button onclick="printReport()">
        <i class="fas fa-print"></i> 打印报表
      </button>
      <button onclick="exportSummary()">
        <i class="fas fa-file-alt"></i> 导出摘要
      </button>
    </div>
    
    <div class="holiday-info">
      <i class="fas fa-info-circle"></i>
      <p>红色标记为新加坡公共假期，加班工资通常为平时的2倍；星期六全天加班1.5倍，星期日全天加班2.0倍</p>
    </div>
    
    <div class="calendar-container">
      <div class="weekdays">
        <div>星期日</div>
        <div>星期一</div>
        <div>星期二</div>
        <div>星期三</div>
        <div>星期四</div>
        <div>星期五</div>
        <div>星期六</div>
      </div>
      
      <div id="calendar"></div>
    </div>
    
    <div class="stats">
      <div class="stat-card">
        <div class="label">加班天数</div>
        <div class="value" id="overtimeDays">0</div>
      </div>
      <div class="stat-card">
        <div class="label">总加班小时</div>
        <div class="value" id="totalHours">0</div>
      </div>
      <div class="stat-card">
        <div class="label">周六加班小时</div>
        <div class="value" id="satHours">0</div>
      </div>
      <div class="stat-card">
        <div class="label">周日加班小时</div>
        <div class="value" id="sunHours">0</div>
      </div>
      <div class="stat-card">
        <div class="label">迟到次数</div>
        <div class="value" id="lateCount">0</div>
      </div>
      <div class="stat-card">
        <div class="label">迟到总分钟</div>
        <div class="value" id="lateMinutes">0</div>
      </div>
      <div class="stat-card late-deduction">
        <div class="label">迟到扣款</div>
        <div class="value" id="lateDeduction">$0</div>
      </div>
      <div class="stat-card salary">
        <div class="label">本月薪资预估</div>
        <div class="value" id="monthSalary">$0</div>
      </div>
    </div>
    
    <footer>
      <p>© 2023 加班打卡系统 | 数据存储在本地浏览器中 | 包含1993-2053年新加坡假期数据</p>
    </footer>
  </div>

  <div id="notification"></div>
  <div class="overlay" id="overlay"></div>
  
  <!-- 编辑打卡记录模态框 -->
  <div class="modal" id="editModal">
    <h3><i class="fas fa-edit"></i> <span id="editDateLabel"></span></h3>
    <label>上班时间</label>
    <input type="time" id="editStart">
    <label>下班时间</label>
    <input type="time" id="editEnd">
    <div class="clock-buttons">
      <button id="saveBtn" onclick="saveEdit()">保存</button>
      <button id="deleteBtn" onclick="deleteRecord()">删除</button>
      <button id="cancelBtn" onclick="closeModal()">取消</button>
    </div>
  </div>
  
  <!-- 系统设置模态框 -->
  <div class="modal" id="settingsModal">
    <h3><i class="fas fa-cog"></i> 系统设置</h3>
    <label>月薪 (SGD):</label>
    <input type="number" id="monthlySalary" min="0" step="100" value="5000">
    
    <label>每小时薪资 (SGD):</label>
    <input type="number" id="hourlyRate" min="0" step="1" value="30" readonly>
    
    <label>迟到扣款/分钟 (SGD):</label>
    <input type="number" id="latePenalty" min="0" step="0.1" value="0.5">
    
    <label>标准上班时间:</label>
    <input type="time" id="workStartTime" value="08:00">
    
    <label>标准下班时间:</label>
    <input type="time" id="workEndTime" value="17:30">
    
    <div class="clock-buttons">
      <button id="saveSettingsBtn" onclick="saveSettings()">保存设置</button>
      <button id="cancelSettingsBtn" onclick="closeSettings()">取消</button>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'worklog-records';
    const SETTINGS_KEY = 'worklog-settings';
    const HOLIDAYS = generateSingaporeHolidays();
    let holidayViewEnabled = false;
    let clockedInToday = false;
    let clockedOutToday = false;
    let settings = {
      monthlySalary: 5000,
      latePenalty: 0.5,
      workStartTime: "08:00",
      workEndTime: "17:30"
    };

    function generateSingaporeHolidays() {
      // 生成1993-2053年的新加坡公共假期数据
      const holidays = {};
      
      // 固定日期假期
      for (let year = 1993; year <= 2053; year++) {
        // 元旦
        holidays[`${year}-01-01`] = '元旦';
        
        // 劳动节
        holidays[`${year}-05-01`] = '劳动节';
        
        // 国庆日
        holidays[`${year}-08-09`] = '国庆日';
        
        // 圣诞节
        holidays[`${year}-12-25`] = '圣诞节';
      }
      
      // 农历新年（基于已知日期和模式）
      const lunarNewYears = {
        '1993': '1993-01-23', '1994': '1994-02-10', '1995': '1995-01-31', '1996': '1996-02-19', '1997': '1997-02-07',
        '1998': '1998-01-28', '1999': '1999-02-16', '2000': '2000-02-05', '2001': '2001-01-24', '2002': '2002-02-12',
        '2003': '2003-02-01', '2004': '2004-01-22', '2005': '2005-02-09', '2006': '2006-01-29', '2007': '2007-02-18',
        '2008': '2008-02-07', '2009': '2009-01-26', '2010': '2010-02-14', '2011': '2011-02-03', '2012': '2012-01-23',
        '2013': '2013-02-10', '2014': '2014-01-31', '2015': '2015-02-19', '2016': '2016-02-08', '2017': '2017-01-28',
        '2018': '2018-02-16', '2019': '2019-02-05', '2020': '2020-01-25', '2021': '2021-02-12', '2022': '2022-02-01',
        '2023': '2023-01-22', '2024': '2024-02-10', '2025': '2025-01-29', '2026': '2026-02-17', '2027': '2027-02-06',
        '2028': '2028-01-26', '2029': '2029-02-13', '2030': '2030-02-03', '2031': '2031-01-23', '2032': '2032-02-11',
        '2033': '2033-01-31', '2034': '2034-02-19', '2035': '2035-02-08', '2036': '2036-01-28', '2037': '2037-02-15',
        '2038': '2038-02-04', '2039': '2039-01-24', '2040': '2040-02-12', '2041': '2041-02-01', '2042': '2042-01-22',
        '2043': '2043-02-10', '2044': '2044-01-30', '2045': '2045-02-17', '2046': '2046-02-06', '2047': '2047-01-26',
        '2048': '2048-02-14', '2049': '2049-02-02', '2050': '2050-01-23', '2051': '2051-02-11', '2052': '2052-02-01',
        '2053': '2053-02-19'
      };
      
      // 添加农历新年（2天）
      for (const [year, date] of Object.entries(lunarNewYears)) {
        const d1 = new Date(date);
        const d2 = new Date(d1);
        d2.setDate(d2.getDate() + 1);
        
        holidays[date] = '农历新年';
        holidays[formatDate(d2)] = '农历新年';
      }
      
      // 其他重要节日（简化版）
      const otherHolidays = {
        // 耶稣受难日（示例日期）
        '2023-04-07': '耶稣受难日',
        '2024-03-29': '耶稣受难日',
        '2025-04-18': '耶稣受难日',
        '2026-04-03': '耶稣受难日',
        
        // 卫塞节
        '2023-05-08': '卫塞节',
        '2024-05-22': '卫塞节',
        '2025-05-12': '卫塞节',
        
        // 开斋节
        '2023-06-02': '开斋节',
        '2024-06-17': '开斋节',
        '2025-06-06': '开斋节',
        
        // 哈芝节
        '2023-06-29': '哈芝节',
        '2024-07-17': '哈芝节',
        '2025-07-07': '哈芝节',
        
        // 屠妖节
        '2023-11-12': '屠妖节',
        '2024-10-31': '屠妖节',
        '2025-10-20': '屠妖节'
      };
      
      // 添加其他节日
      for (const [date, name] of Object.entries(otherHolidays)) {
        holidays[date] = name;
      }
      
      return holidays;
    }

    function getRecords() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    }

    function saveRecords(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }
    
    function getSettings() {
      const savedSettings = localStorage.getItem(SETTINGS_KEY);
      return savedSettings ? JSON.parse(savedSettings) : settings;
    }
    
    function saveSettings() {
      settings.monthlySalary = parseFloat(document.getElementById('monthlySalary').value) || 5000;
      settings.latePenalty = parseFloat(document.getElementById('latePenalty').value) || 0.5;
      settings.workStartTime = document.getElementById('workStartTime').value || "08:00";
      settings.workEndTime = document.getElementById('workEndTime').value || "17:30";
      
      // 计算时薪
      const hourlyRate = settings.monthlySalary / (22 * 8);
      document.getElementById('hourlyRate').value = hourlyRate.toFixed(2);
      
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      closeSettings();
      renderCalendar();
      calculateSalary();
      showNotification('系统设置已保存');
    }

    function formatDate(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getCurrentTime() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    function getMonthDates(year, month) {
      const dates = [];
      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);
      const startDay = first.getDay();

      for (let i = 0; i < startDay; i++) {
        dates.push(null);
      }

      for (let i = 1; i <= last.getDate(); i++) {
        dates.push(new Date(year, month, i));
      }
      return dates;
    }
    
    function calculateOvertime(dateStr, start, end) {
      if (!start || !end) return 0;
      
      const [startHour, startMin] = start.split(':').map(Number);
      const [endHour, endMin] = end.split(':').map(Number);
      
      const startTotal = startHour * 60 + startMin;
      const endTotal = endHour * 60 + endMin;
      
      // 获取日期对象
      const date = new Date(dateStr);
      const dayOfWeek = date.getDay();
      
      // 对于周六和周日，全天工作时间都算作加班
      if (dayOfWeek === 0 || dayOfWeek === 6) {
        const totalMinutes = endTotal - startTotal;
        return totalMinutes / 60; // 返回全天工作时间（小时）
      }
      
      // 对于工作日：只计算标准下班时间之后的时间
      const [endHourWork, endMinWork] = settings.workEndTime.split(':').map(Number);
      const normalEndTime = endHourWork * 60 + endMinWork;
      
      const overtime = Math.max(0, endTotal - normalEndTime);
      return overtime / 60; // 转换为小时
    }
    
    function calculateLateMinutes(dateStr, startTime) {
      if (!startTime) return 0;
      
      // 获取日期对象
      const date = new Date(dateStr);
      const dayOfWeek = date.getDay();
      
      // 周末不计迟到（0=周日，6=周六）
      if (dayOfWeek === 0 || dayOfWeek === 6) {
        return 0;
      }
      
      // 检查是否是假期
      if (HOLIDAYS[dateStr] !== undefined) {
        return 0;
      }
      
      const [startHour, startMin] = startTime.split(':').map(Number);
      const startTotal = startHour * 60 + startMin;
      
      // 上班时间
      const [startHourWork, startMinWork] = settings.workStartTime.split(':').map(Number);
      const onTime = startHourWork * 60 + startMinWork;
      
      // 迟到分钟数
      return Math.max(0, startTotal - onTime);
    }
    
    function getPayPeriodDates(periodType, selectedMonth) {
      // 解析选中的月份
      const [year, month] = selectedMonth.split('-').map(Number);
      const baseDate = new Date(year, month - 1, 1);
      
      let startDate, endDate;
      
      if (periodType === 'current') {
        // 当前周期：上个月18号到这个月17号
        startDate = new Date(year, month - 2, 18);
        endDate = new Date(year, month - 1, 17);
      } else if (periodType === 'last') {
        // 上个月周期：上上个月18号到上个月17号
        startDate = new Date(year, month - 3, 18);
        endDate = new Date(year, month - 2, 17);
      } else {
        // 自定义周期（默认当前周期）
        startDate = new Date(year, month - 2, 18);
        endDate = new Date(year, month - 1, 17);
      }
      
      // 确保结束日期不会超过今天
      const today = new Date();
      if (endDate > today) endDate = today;
      
      return {
        start: startDate,
        end: endDate,
        display: `${formatDate(startDate)} 至 ${formatDate(endDate)}`
      };
    }

    function renderCalendar() {
      const picker = document.getElementById('monthPicker');
      const selectedMonth = picker.value;
      const [year, month] = selectedMonth.split('-').map(Number);
      const cal = document.getElementById('calendar');
      const data = getRecords();
      const today = new Date();
      const todayStr = formatDate(today);
      
      cal.innerHTML = '';
      const dates = getMonthDates(year, month - 1);
      
      let overtimeDays = 0;
      let totalHours = 0;
      let holidayDays = 0;
      let lateCount = 0;
      let totalLateMinutes = 0;
      let deductionAmount = 0;
      let satHours = 0;
      let sunHours = 0;

      dates.forEach(d => {
        const div = document.createElement('div');
        div.className = 'day';
        
        if (!d) {
          div.classList.add('inactive');
          cal.appendChild(div);
          return;
        }
        
        const dateStr = formatDate(d);
        const dayOfWeek = d.getDay();
        const isToday = dateStr === todayStr;
        const isSaturday = dayOfWeek === 6;
        const isSunday = dayOfWeek === 0;
        const isHoliday = HOLIDAYS[dateStr] !== undefined;
        
        if (isSaturday) {
          div.classList.add('saturday');
        } else if (isSunday) {
          div.classList.add('sunday');
        }
        
        if (isHoliday && holidayViewEnabled) {
          div.classList.add('holiday');
        }
        
        const rec = data.find(r => r.date === dateStr);
        const overtime = rec ? calculateOvertime(dateStr, rec.start, rec.end) : 0;
        // 假期和周末不算迟到
        const lateMinutes = rec ? calculateLateMinutes(dateStr, rec.start) : 0;
        
        if (overtime > 0) {
          overtimeDays++;
          totalHours += overtime;
          
          if (isSaturday) {
            satHours += overtime;
          } else if (isSunday) {
            sunHours += overtime;
          }
          
          if (isHoliday || isSaturday || isSunday) {
            holidayDays++;
          }
        }
        
        if (lateMinutes > 0) {
          lateCount++;
          totalLateMinutes += lateMinutes;
          deductionAmount += lateMinutes * settings.latePenalty;
        }
        
        let overtimeRate = '';
        if (isSaturday) {
          overtimeRate = '<span class="overtime-rate">1.5x</span>';
        } else if (isSunday) {
          overtimeRate = '<span class="overtime-rate">2.0x</span>';
        }
        
        div.innerHTML = `
          <div class="date-label">
            ${d.getDate()}
            ${isToday ? '<span class="current-indicator">今</span>' : ''}
            ${overtimeRate}
          </div>
        `;
        
        if (isHoliday && holidayViewEnabled) {
          div.innerHTML += `<div class="holiday-label">${HOLIDAYS[dateStr]}</div>`;
        }
        
        if (rec) {
          div.innerHTML += `
            <div class="record">
              <span>上班:</span>
              <span class="time">${rec.start || ''}</span>
            </div>
            <div class="record">
              <span>下班:</span>
              <span class="time">${rec.end || ''}</span>
            </div>
          `;
          
          if (lateMinutes > 0) {
            div.innerHTML += `
              <div class="late">
                迟到 ${lateMinutes} 分钟
              </div>
              <div class="deduction">
                扣款 $${(lateMinutes * settings.latePenalty).toFixed(2)}
              </div>
            `;
          }
          
          if (overtime > 0) {
            div.innerHTML += `
              <div class="overtime">
                加班 ${overtime.toFixed(1)} 小时
              </div>
            `;
          }
        }
        
        div.onclick = () => openModal(dateStr, rec);
        cal.appendChild(div);
      });
      
      // 更新统计
      document.getElementById('overtimeDays').textContent = overtimeDays;
      document.getElementById('totalHours').textContent = totalHours.toFixed(1);
      document.getElementById('satHours').textContent = satHours.toFixed(1);
      document.getElementById('sunHours').textContent = sunHours.toFixed(1);
      document.getElementById('lateCount').textContent = lateCount;
      document.getElementById('lateMinutes').textContent = totalLateMinutes;
      document.getElementById('lateDeduction').textContent = `$${deductionAmount.toFixed(2)}`;
      
      // 更新薪资周期显示（基于选择的月份）
      const periodType = document.getElementById('payPeriodSelect').value;
      const period = getPayPeriodDates(periodType, selectedMonth);
      document.getElementById('payPeriodDates').textContent = period.display;
    }

    function toggleHolidays() {
      holidayViewEnabled = !holidayViewEnabled;
      document.getElementById('holidayToggle').innerHTML = 
        holidayViewEnabled ? 
        '<i class="fas fa-calendar-day"></i> 标准视图' : 
        '<i class="fas fa-calendar-day"></i> 假期视图';
      
      renderCalendar();
      showNotification(holidayViewEnabled ? '已启用假期视图' : '已启用标准视图');
    }
    
    function showExportOptions() {
      const options = document.getElementById('exportOptions');
      options.style.display = options.style.display === 'flex' ? 'none' : 'flex';
    }

    let editingDate = '';

    function openModal(date, rec) {
      editingDate = date;
      document.getElementById('editDateLabel').textContent = `编辑：${date}`;
      document.getElementById('editStart').value = rec?.start || '';
      document.getElementById('editEnd').value = rec?.end || '';
      document.getElementById('editModal').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('editModal').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }
    
    function openSettings() {
      const savedSettings = getSettings();
      document.getElementById('monthlySalary').value = savedSettings.monthlySalary;
      document.getElementById('latePenalty').value = savedSettings.latePenalty;
      document.getElementById('workStartTime').value = savedSettings.workStartTime;
      document.getElementById('workEndTime').value = savedSettings.workEndTime;
      
      // 计算时薪
      const hourlyRate = savedSettings.monthlySalary / (22 * 8);
      document.getElementById('hourlyRate').value = hourlyRate.toFixed(2);
      
      document.getElementById('settingsModal').style.display = 'block';
      document.getElementById('overlay').style.display = 'block';
    }
    
    function closeSettings() {
      document.getElementById('settingsModal').style.display = 'none';
      document.getElementById('overlay').style.display = 'none';
    }

    function saveEdit() {
      const start = document.getElementById('editStart').value;
      const end = document.getElementById('editEnd').value;
      const records = getRecords();
      let rec = records.find(r => r.date === editingDate);
      if (!rec) {
        rec = { date: editingDate };
        records.push(rec);
      }
      rec.start = start;
      rec.end = end;
      saveRecords(records);
      closeModal();
      renderCalendar();
      showNotification('打卡记录已保存');
    }

    function deleteRecord() {
      let records = getRecords();
      records = records.filter(r => r.date !== editingDate);
      saveRecords(records);
      closeModal();
      renderCalendar();
      showNotification('打卡记录已删除');
    }

    function exportCSV() {
      const periodType = document.getElementById('payPeriodSelect').value;
      const selectedMonth = document.getElementById('monthPicker').value;
      const period = getPayPeriodDates(periodType, selectedMonth);
      
      const data = getRecords().filter(r => {
        const recordDate = new Date(r.date);
        return recordDate >= period.start && recordDate <= period.end;
      });
      
      let csv = '日期,上班时间,下班时间,加班时长(小时),加班倍率,迟到分钟,扣款金额\n';
      data.forEach(r => {
        const recordDate = new Date(r.date);
        const dayOfWeek = recordDate.getDay();
        const isSaturday = dayOfWeek === 6;
        const isSunday = dayOfWeek === 0;
        const isHoliday = HOLIDAYS[r.date] !== undefined;
        
        let rate = '1.5';
        if (isHoliday || isSunday) {
          rate = '2.0';
        } else if (!isSaturday && !isSunday) {
          rate = '1.5';
        }
        
        const overtime = calculateOvertime(r.date, r.start, r.end);
        const lateMinutes = calculateLateMinutes(r.date, r.start);
        const deduction = lateMinutes * settings.latePenalty;
        csv += `${r.date},${r.start || ''},${r.end || ''},${overtime.toFixed(1)},${rate}x,${lateMinutes},${deduction.toFixed(2)}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `加班记录_${periodType}_周期.csv`;
      a.click();
      showNotification('CSV导出成功');
    }
    
    function exportExcel() {
      const periodType = document.getElementById('payPeriodSelect').value;
      const selectedMonth = document.getElementById('monthPicker').value;
      const period = getPayPeriodDates(periodType, selectedMonth);
      
      const data = getRecords().filter(r => {
        const recordDate = new Date(r.date);
        return recordDate >= period.start && recordDate <= period.end;
      });
      
      const excelData = data.map(r => {
        const date = new Date(r.date);
        const dayOfWeek = date.getDay();
        const isSaturday = dayOfWeek === 6;
        const isSunday = dayOfWeek === 0;
        const isHoliday = HOLIDAYS[r.date] !== undefined;
        
        let rate = '1.5';
        if (isHoliday || isSunday) {
          rate = '2.0';
        } else if (!isSaturday && !isSunday) {
          rate = '1.5';
        }
        
        const overtime = calculateOvertime(r.date, r.start, r.end);
        const lateMinutes = calculateLateMinutes(r.date, r.start);
        const deduction = lateMinutes * settings.latePenalty;
        return {
          '日期': r.date,
          '上班时间': r.start || '',
          '下班时间': r.end || '',
          '加班时长(小时)': overtime.toFixed(1),
          '加班倍率': rate + 'x',
          '迟到分钟': lateMinutes,
          '扣款金额': deduction.toFixed(2),
          '是否假期': isHoliday ? '是' : '否',
          '星期': ['日','一','二','三','四','五','六'][dayOfWeek]
        };
      });
      
      const worksheet = XLSX.utils.json_to_sheet(excelData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, '加班记录');
      
      // 添加摘要数据
      const summaryData = [
        ['统计项', '数值'],
        ['总记录数', data.length],
        ['总加班小时', data.reduce((sum, r) => sum + calculateOvertime(r.date, r.start, r.end), 0).toFixed(1)],
        ['周六加班小时', data.filter(r => new Date(r.date).getDay() === 6).reduce((sum, r) => sum + calculateOvertime(r.date, r.start, r.end), 0).toFixed(1)],
        ['周日加班小时', data.filter(r => new Date(r.date).getDay() === 0).reduce((sum, r) => sum + calculateOvertime(r.date, r.start, r.end), 0).toFixed(1)],
        ['迟到次数', data.filter(r => calculateLateMinutes(r.date, r.start) > 0).length],
        ['迟到总分钟', data.reduce((sum, r) => sum + calculateLateMinutes(r.date, r.start), 0)],
        ['迟到扣款总额', data.reduce((sum, r) => sum + (calculateLateMinutes(r.date, r.start) * settings.latePenalty), 0).toFixed(2)],
        ['假期加班天数', data.filter(r => HOLIDAYS[r.date] !== undefined).length]
      ];
      
      const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(workbook, summarySheet, '统计摘要');
      
      XLSX.writeFile(workbook, `加班记录_${periodType}_周期.xlsx`);
      showNotification('Excel导出成功');
    }
    
    function printReport() {
      const periodType = document.getElementById('payPeriodSelect').value;
      const selectedMonth = document.getElementById('monthPicker').value;
      const period = getPayPeriodDates(periodType, selectedMonth);
      
      const data = getRecords().filter(r => {
        const recordDate = new Date(r.date);
        return recordDate >= period.start && recordDate <= period.end;
      });
      
      let printContent = `
        <style>
          body { font-family: sans-serif; }
          h1 { text-align: center; }
          table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; }
          .summary { margin-top: 30px; font-weight: bold; }
        </style>
        <h1>加班记录报表 (${period.display})</h1>
        <table>
          <thead>
            <tr>
              <th>日期</th>
              <th>星期</th>
              <th>上班时间</th>
              <th>下班时间</th>
              <th>加班时长(小时)</th>
              <th>加班倍率</th>
              <th>迟到分钟</th>
              <th>扣款金额</th>
              <th>是否假期</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach(r => {
        const recordDate = new Date(r.date);
        const dayOfWeek = recordDate.getDay();
        const isSaturday = dayOfWeek === 6;
        const isSunday = dayOfWeek === 0;
        const isHoliday = HOLIDAYS[r.date] !== undefined;
        
        let rate = '1.5';
        if (isHoliday || isSunday) {
          rate = '2.0';
        } else if (!isSaturday && !isSunday) {
          rate = '1.5';
        }
        
        const overtime = calculateOvertime(r.date, r.start, r.end);
        const lateMinutes = calculateLateMinutes(r.date, r.start);
        const deduction = lateMinutes * settings.latePenalty;
        
        printContent += `
          <tr>
            <td>${r.date}</td>
            <td>${['日','一','二','三','四','五','六'][dayOfWeek]}</td>
            <td>${r.start || ''}</td>
            <td>${r.end || ''}</td>
            <td>${overtime.toFixed(1)}</td>
            <td>${rate}x</td>
            <td>${lateMinutes}</td>
            <td>$${deduction.toFixed(2)}</td>
            <td>${isHoliday ? '是' : '否'}</td>
          </tr>
        `;
      });
      
      const totalOvertime = data.reduce((sum, r) => sum + calculateOvertime(r.date, r.start, r.end), 0).toFixed(1);
      const satOvertime = data.filter(r => new Date(r.date).getDay() === 6).reduce((sum, r) => sum + calculateOvertime(r.date, r.start, r.end), 0).toFixed(1);
      const sunOvertime = data.filter(r => new Date(r.date).getDay() === 0).reduce((sum, r) => sum + calculateOvertime(r.date, r.start, r.end), 0).toFixed(1);
      const lateCount = data.filter(r => calculateLateMinutes(r.date, r.start) > 0).length;
      const totalLateMinutes = data.reduce((sum, r) => sum + calculateLateMinutes(r.date, r.start), 0);
      const totalDeduction = data.reduce((sum, r) => sum + (calculateLateMinutes(r.date, r.start) * settings.latePenalty), 0).toFixed(2);
      const holidayDays = data.filter(r => HOLIDAYS[r.date] !== undefined).length;
      
      printContent += `
          </tbody>
        </table>
        <div class="summary">
          <p><strong>总记录数:</strong> ${data.length}</p>
          <p><strong>总加班小时:</strong> ${totalOvertime}</p>
          <p><strong>周六加班小时:</strong> ${satOvertime}</p>
          <p><strong>周日加班小时:</strong> ${sunOvertime}</p>
          <p><strong>迟到次数:</strong> ${lateCount}</p>
          <p><strong>迟到总分钟:</strong> ${totalLateMinutes}</p>
          <p><strong>迟到扣款总额:</strong> $${totalDeduction}</p>
          <p><strong>假期加班天数:</strong> ${holidayDays}</p>
        </div>
      `;
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
    }
    
    function exportSummary() {
      const periodType = document.getElementById('payPeriodSelect').value;
      const selectedMonth = document.getElementById('monthPicker').value;
      const period = getPayPeriodDates(periodType, selectedMonth);
      
      const data = getRecords().filter(r => {
        const recordDate = new Date(r.date);
        return recordDate >= period.start && recordDate <= period.end;
      });
      
      let summary = `加班记录摘要 (${period.display})\n\n`;
      summary += `总记录数: ${data.length}\n`;
      summary += `总加班小时: ${data.reduce((sum, r) => sum + calculateOvertime(r.date, r.start, r.end), 0).toFixed(1)}\n`;
      summary += `周六加班小时: ${data.filter(r => new Date(r.date).getDay() === 6).reduce((sum, r) => sum + calculateOvertime(r.date, r.start, r.end), 0).toFixed(1)}\n`;
      summary += `周日加班小时: ${data.filter(r => new Date(r.date).getDay() === 0).reduce((sum, r) => sum + calculateOvertime(r.date, r.start, r.end), 0).toFixed(1)}\n`;
      summary += `迟到次数: ${data.filter(r => calculateLateMinutes(r.date, r.start) > 0).length}\n`;
      summary += `迟到总分钟: ${data.reduce((sum, r) => sum + calculateLateMinutes(r.date, r.start), 0)}\n`;
      summary += `迟到扣款总额: $${data.reduce((sum, r) => sum + (calculateLateMinutes(r.date, r.start) * settings.latePenalty), 0).toFixed(2)}\n`;
      summary += `假期加班天数: ${data.filter(r => HOLIDAYS[r.date] !== undefined).length}\n\n`;
      
      summary += "详细记录:\n";
      summary += "日期\t星期\t上班时间\t下班时间\t加班时长\t加班倍率\t迟到分钟\t扣款金额\t是否假期\n";
      
      data.forEach(r => {
        const date = new Date(r.date);
        const dayOfWeek = date.getDay();
        const isSaturday = dayOfWeek === 6;
        const isSunday = dayOfWeek === 0;
        const isHoliday = HOLIDAYS[r.date] !== undefined;
        
        let rate = '1.5';
        if (isHoliday || isSunday) {
          rate = '2.0';
        } else if (!isSaturday && !isSunday) {
          rate = '1.5';
        }
        
        const overtime = calculateOvertime(r.date, r.start, r.end);
        const lateMinutes = calculateLateMinutes(r.date, r.start);
        const deduction = lateMinutes * settings.latePenalty;
        
        summary += `${r.date}\t${['日','一','二','三','四','五','六'][dayOfWeek]}\t${r.start || ''}\t${r.end || ''}\t${overtime.toFixed(1)}\t${rate}x\t${lateMinutes}\t$${deduction.toFixed(2)}\t${isHoliday ? '是' : '否'}\n`;
      });
      
      const blob = new Blob([summary], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `加班摘要_${periodType}_周期.txt`;
      a.click();
      showNotification('摘要导出成功');
    }

    function clockIn() {
      if (clockedInToday) {
        showNotification('您今天已经打过上班卡了');
        return;
      }
      
      const now = new Date();
      const dateStr = formatDate(now);
      const timeStr = getCurrentTime();
      
      const records = getRecords();
      let rec = records.find(r => r.date === dateStr);
      if (!rec) {
        rec = { date: dateStr };
        records.push(rec);
      }
      
      // 记录上班打卡
      rec.start = timeStr;
      saveRecords(records);
      renderCalendar();
      
      // 计算迟到分钟数（假期和周末不算迟到）
      const lateMinutes = calculateLateMinutes(dateStr, timeStr);
      
      if (lateMinutes > 0) {
        showNotification(`上班打卡成功: ${timeStr} | 迟到 ${lateMinutes} 分钟 | 扣款 $${(lateMinutes * settings.latePenalty).toFixed(2)}`);
      } else {
        showNotification(`上班打卡成功: ${timeStr} | 准时上班`);
      }
      
      clockedInToday = true;
    }

    function clockOut() {
      if (clockedOutToday) {
        showNotification('您今天已经打过下班卡了');
        return;
      }
      
      const now = new Date();
      const dateStr = formatDate(now);
      const timeStr = getCurrentTime();
      
      const records = getRecords();
      let rec = records.find(r => r.date === dateStr);
      if (!rec) {
        rec = { date: dateStr };
        records.push(rec);
      }
      
      // 检查是否已打卡上班
      if (!rec.start) {
        showNotification('请先打卡上班');
        return;
      }
      
      rec.end = timeStr;
      saveRecords(records);
      renderCalendar();
      
      const overtime = calculateOvertime(dateStr, rec.start, rec.end);
      showNotification(`下班打卡成功: ${timeStr} | 加班时长: ${overtime.toFixed(1)}小时`);
      
      clockedOutToday = true;
    }

    function calculateSalary() {
      const periodType = document.getElementById('payPeriodSelect').value;
      const selectedMonth = document.getElementById('monthPicker').value;
      const period = getPayPeriodDates(periodType, selectedMonth);
      
      const settings = getSettings();
      const monthlySalary = settings.monthlySalary;
      const latePenalty = settings.latePenalty;
      
      // 计算时薪（每月按22个工作日，每天8小时）
      const hourlyRate = monthlySalary / (22 * 8);
      
      // 获取记录
      const records = getRecords().filter(r => {
        const recordDate = new Date(r.date);
        return recordDate >= period.start && recordDate <= period.end;
      });
      
      let overtimePay = 0;
      let lateDeduction = 0;
      
      // 计算周期数据
      records.forEach(r => {
        const recordDate = new Date(r.date);
        const isHoliday = HOLIDAYS[r.date] !== undefined;
        const dayOfWeek = recordDate.getDay();
        const isSaturday = dayOfWeek === 6;
        const isSunday = dayOfWeek === 0;
        
        // 计算加班费
        const overtime = calculateOvertime(r.date, r.start, r.end);
        if (overtime > 0) {
          if (isHoliday || isSunday) {
            // 节假日或周日加班：2倍工资
            overtimePay += overtime * hourlyRate * 2;
          } else if (isSaturday) {
            // 周六加班：1.5倍工资
            overtimePay += overtime * hourlyRate * 1.5;
          } else {
            // 平日加班：1.5倍工资
            overtimePay += overtime * hourlyRate * 1.5;
          }
        }
        
        // 计算迟到扣款（假期和周末不算迟到）
        const lateMinutes = calculateLateMinutes(r.date, r.start);
        lateDeduction += lateMinutes * latePenalty;
      });
      
      // 计算本月总工资
      const totalSalary = monthlySalary + overtimePay - lateDeduction;
      
      // 更新UI
      document.getElementById('monthSalary').textContent = `$${totalSalary.toFixed(2)}`;
      document.getElementById('lateDeduction').textContent = `$${lateDeduction.toFixed(2)}`;
      
      showNotification(`薪资计算完成: 基本$${monthlySalary} + 加班费$${overtimePay.toFixed(2)} - 迟到扣款$${lateDeduction.toFixed(2)} = 总工资$${totalSalary.toFixed(2)}`);
    }

    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
      notification.style.display = 'flex';
      
      setTimeout(() => {
        notification.style.display = 'none';
      }, 5000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const now = new Date();
      const currentMonth = now.toISOString().slice(0,7);
      document.getElementById('monthPicker').value = currentMonth;
      
      // 加载设置
      const savedSettings = getSettings();
      settings = savedSettings;
      
      // 初始化薪资周期（基于当前月份）
      const periodType = document.getElementById('payPeriodSelect').value;
      const period = getPayPeriodDates(periodType, currentMonth);
      document.getElementById('payPeriodDates').textContent = period.display;
      
      renderCalendar();
      
      // 监听月份选择器变化
      document.getElementById('monthPicker').addEventListener('change', function() {
        renderCalendar();
        calculateSalary();
      });
      
      // 绑定打卡按钮
      document.getElementById('clockInBtn').addEventListener('click', clockIn);
      document.getElementById('clockOutBtn').addEventListener('click', clockOut);
      
      // 绑定薪资周期选择
      document.getElementById('payPeriodSelect').addEventListener('change', function() {
        const selectedMonth = document.getElementById('monthPicker').value;
        const period = getPayPeriodDates(this.value, selectedMonth);
        document.getElementById('payPeriodDates').textContent = period.display;
        renderCalendar();
        calculateSalary();
      });
      
      // 初始化薪资计算
      calculateSalary();
      
      // 重置每天的打卡状态
      setInterval(() => {
        const now = new Date();
        if (now.getHours() === 0 && now.getMinutes() === 0) {
          clockedInToday = false;
          clockedOutToday = false;
        }
      }, 60000); // 每分钟检查一次
    });
  </script>
</body>
</html>